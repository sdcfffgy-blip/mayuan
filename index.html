<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>é©¬åŸæœŸæœ«å¤ä¹  - å†³æˆ˜ç‰ˆ V35.3 (å½»åº•ä¿®å¤é”™é¢˜å¤æ´»BUG)</title>
    <style>
      :root {
        --primary: #4f46e5;
        --primary-light: #eef2ff;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --info: #0ea5e9;
        --text-main: #0f172a; 
        --text-sub: #64748b;
        --bg-body: #f8fafc;
        --bg-sidebar: #ffffff;
        --bg-card: #ffffff;
        --border-color: #e2e8f0;
        --sidebar-width: 280px;
        --safe-bottom: env(safe-area-inset-bottom, 20px);
        --content-font-size: 1.35rem; 
      }

      body.dark-mode {
        --primary: #818cf8;
        --primary-light: #312e81;
        --success: #34d399;
        --warning: #fbbf24;
        --error: #f87171;
        --info: #38bdf8;
        --text-main: #f1f5f9;
        --text-sub: #94a3b8;
        --bg-body: #0f172a;
        --bg-sidebar: #1e293b;
        --bg-card: #1e293b;
        --border-color: #334155;
      }

      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      body { margin: 0; padding: 0; font-family: "PingFang SC", "Microsoft YaHei", -apple-system, sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; transition: background 0.3s, color 0.3s; }

      /* === ä¾§è¾¹æ  === */
      .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s; flex-shrink: 0; }
      .sidebar-header { padding: 15px; background: var(--bg-sidebar); border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; }
      .app-brand { font-size: 1.2rem; font-weight: 900; color: var(--primary); text-align: center; display: flex; justify-content: center; gap: 8px; align-items: center; }

      .search-box { position: relative; width: 100%; }
      .search-input { width: 100%; padding: 8px 10px 8px 30px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); font-size: 0.85rem; }
      .search-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 0.9rem; opacity: 0.5; }

      /* å­¦ä¹ ç»Ÿè®¡æ¨¡å— */
      .study-stats-card { background: var(--bg-body); border-radius: 8px; padding: 10px; font-size: 0.8rem; display: flex; flex-direction: column; gap: 5px; border: 1px solid var(--border-color); }
      .stats-row { display: flex; justify-content: space-between; color: var(--text-sub); }
      .stats-val { font-weight: bold; color: var(--text-main); }
      .daily-progress { height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden; margin-top: 2px; }
      .daily-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }

      .countdown-card { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; box-shadow: 0 4px 6px rgba(239, 68, 68, 0.25); animation: pulse 2s infinite; }
      .countdown-num { font-size: 1.4rem; font-weight: 800; margin: 0 4px; text-decoration: underline; text-underline-offset: 3px; }
      @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

      .func-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
      .func-btn { border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; white-space: nowrap; background: var(--bg-card); color: var(--text-sub); }
      .func-btn:hover { background: var(--bg-body); }
      .func-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
      
      .btn-recite.active { background: var(--info); border-color: var(--info); color: white; }
      .btn-wrong.active { background: var(--error); border-color: var(--error); color: white; }
      .btn-fav.active { background: var(--warning); border-color: var(--warning); color: white; }
      
      .chapter-list { flex: 1; overflow-y: auto; padding: 8px; }
      .chapter-item { padding: 10px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: var(--text-sub); transition: 0.2s; border: 1px solid transparent; font-size: 0.85rem; }
      .chapter-item:hover { background: var(--bg-body); }
      .chapter-item.active { background: var(--primary-light); color: var(--primary); border-color: var(--primary); font-weight: 600; }
      .badge-pill { font-size: 0.75rem; padding: 1px 6px; border-radius: 4px; background: var(--border-color); color: var(--text-sub); }
      .chapter-item.active .badge-pill { background: var(--bg-card); color: var(--primary); }
      .chapter-item .badge-pill.completed { background: var(--success); color: white; }
      .chapter-item .badge-pill.low-score { background: var(--error); color: white; }

      .sidebar-footer { padding: 12px; border-top: 1px solid var(--border-color); background: var(--bg-sidebar); display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
      .tool-btn { background: var(--bg-body); border: 1px solid var(--border-color); color: var(--text-sub); padding: 6px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; justify-content: center; }
      .tool-btn:hover { color: var(--primary); border-color: var(--primary); }

      /* === ä¸»å†…å®¹åŒº === */
      .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; background: var(--bg-body); position: relative; min-width: 0; }
      
      .exam-bar { background: #1e293b; color: white; padding: 10px 15px; display: none; justify-content: space-between; align-items: center; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
      .exam-bar.active { display: flex; }

      .top-nav { background: var(--bg-card); padding: 12px 20px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; gap: 10px; z-index: 20; border-bottom: 1px solid var(--border-color); }
      .nav-row { display: flex; align-items: center; justify-content: space-between; }
      .menu-toggle { font-size: 1.4rem; background: none; border: none; color: var(--text-sub); cursor: pointer; display: none; margin-right: 10px; }
      .nav-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 300px; }
      .jump-box { padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; color: var(--text-main); outline: none; background: var(--bg-body); max-width: 140px; }
      
      .jump-unfinished-btn { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2); }
      .jump-unfinished-btn:active { transform: scale(0.95); }
      
      .filter-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 2px; scrollbar-width: none; align-items: center; }
      .filter-chip { padding: 6px 14px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-sub); font-size: 0.85rem; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: 0.2s; font-weight: 500; }
      .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
      .filter-chip.active-wrong { background: var(--error); color: white; border-color: var(--error); }
      .filter-chip.active-recite { background: var(--info); color: white; border-color: var(--info); }
      .filter-chip.active-kill { background: #10b981; color: white; border-color: #10b981; }
      .filter-chip.active-speed { background: #8b5cf6; color: white; border-color: #8b5cf6; }
      .filter-chip.active-clean { background: #6366f1; color: white; border-color: #6366f1; }
      
      .auto-next-chip { border-style: solid; border-color: var(--warning); color: var(--warning); background: transparent; }
      .auto-next-chip.active { background: var(--warning); color: white; }

      .progress-container { height: 4px; background: var(--border-color); width: 100%; border-radius: 2px; overflow: hidden; position: relative; }
      .progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease; }
      .progress-bar.recite-bar { background: var(--info); }

      .content-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; justify-content: center; padding-bottom: 100px; }
      
      .card { background: var(--bg-card); border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04); padding: 30px; width: 98%; max-width: 1600px; height: fit-content; margin-bottom: 20px; position: relative; border: 1px solid var(--border-color); transition: border-color 0.3s; }

      .card.recite-mode { border-left: 6px solid var(--info); overflow: visible; }
      .card.wrong-mode { border-left: 6px solid var(--error); }
      .card.fav-mode { border-left: 6px solid var(--warning); }
      .card.mock-mode { border-left: 6px solid #8b5cf6; }
      .card.search-mode { border-left: 6px solid #ec4899; }
      .card.speed-mode { border-left: 6px solid #8b5cf6; } 
      
      .card.mastered-card { opacity: 0.7; border-style: dashed; }
      .mastered-badge { position: absolute; top: 15px; right: 60px; background: #10b981; color: white; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; transform: rotate(10deg); box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 2px solid white; z-index: 20; }

      .q-header { display: flex; justify-content: space-between; margin-bottom: 25px; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; flex-wrap: wrap; gap: 10px; }
      .q-type { font-size: 0.85rem; padding: 4px 10px; border-radius: 6px; font-weight: 700; background: var(--bg-body); color: var(--text-sub); border: 1px solid var(--border-color); }
      .q-type.single { color: #0284c7; border-color: #0284c7; background: #e0f2fe; }
      .q-type.multi { color: #d97706; border-color: #d97706; background: #fef3c7; }
      .dark-mode .q-type.single { background: rgba(2, 132, 199, 0.2); }
      .dark-mode .q-type.multi { background: rgba(217, 119, 6, 0.2); }
      
      .chapter-tag { font-size: 0.85rem; color: var(--text-sub); background: var(--bg-body); padding: 4px 10px; border-radius: 6px; margin-left: 10px; border: 1px solid var(--border-color); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle; }
      
      /* æ–°å¢ï¼šç»Ÿè®¡è§’æ ‡æ ·å¼ */
      .stats-badge { font-size: 0.75rem; color: var(--text-sub); background: var(--bg-body); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border-color); display: flex; gap: 6px; align-items: center; margin-left: auto; }
      .stats-val-c { color: var(--success); font-weight: bold; }
      .stats-val-w { color: var(--error); font-weight: bold; }

      .star-icon { font-size: 1.6rem; color: var(--border-color); cursor: pointer; margin-left: 10px; transition: transform 0.2s; }
      .star-icon.active { color: #f59e0b; transform: scale(1.2); }

      .q-content { font-size: var(--content-font-size); line-height: 1.8; color: var(--text-main); margin-bottom: 30px; white-space: pre-wrap; font-weight: 600; letter-spacing: 0.02em; }
      
      .card.recite-mode .q-content { position: sticky; top: -20px; z-index: 10; background: var(--bg-card); padding: 20px 0; border-bottom: 4px solid var(--primary-light); margin-bottom: 30px; margin-top: -15px; box-shadow: 0 4px 12px -4px rgba(0,0,0,0.1); }
      
      .opts-container { display: flex; flex-direction: column; gap: 16px; }
      .opt-row { display: flex; padding: 18px 20px; border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; background: var(--bg-card); transition: all 0.15s ease; align-items: flex-start; }
      .opt-row:hover { border-color: var(--primary); background: var(--bg-body); transform: translateX(5px); }
      .opt-row:active { transform: scale(0.995); }
      
      .card.recite-mode .opts-container { pointer-events: none; gap: 18px; } 
      .card.recite-mode .opt-row { border-color: var(--border-color); background: var(--bg-card); }
      .card.recite-mode .opt-row.correct { background: #f0fdf4; border-color: #22c55e; transform: scale(1.01); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.1); }
      .card.recite-mode .opt-row.correct .opt-icon { background: #22c55e; border-color: #22c55e; color: white; font-weight: 900; }
      .card.recite-mode .opt-row.correct .opt-text { font-weight: 700; color: #15803d; }
      
      .card.recite-mode.clean-mode .opt-row:not(.correct) { opacity: 0.15; filter: grayscale(100%); }
      
      .opt-icon { width: 32px; height: 32px; margin-right: 15px; border: 2px solid var(--text-sub); display: flex; align-items: center; justify-content: center; color: var(--text-sub); flex-shrink: 0; font-size: 1rem; font-weight: bold; background: transparent; transition: all 0.2s; }
      .opt-row.single-mode .opt-icon { border-radius: 50%; }
      .opt-row.multi-mode .opt-icon { border-radius: 6px; }

      .opt-row.selected { border-color: var(--primary); background: var(--primary-light); }
      .opt-row.selected .opt-icon { background: var(--primary); border-color: var(--primary); color: white; }
      .dark-mode .opt-row.selected { background: rgba(99, 102, 241, 0.2); }

      .opt-row.correct { border-color: var(--success); background: #ecfdf5; }
      .opt-row.correct .opt-icon { background: var(--success); border-color: var(--success); color: white; }
      
      .opt-row.wrong { border-color: var(--error); background: #fef2f2; }
      .opt-row.wrong .opt-icon { background: var(--error); border-color: var(--error); color: white; }
      .dark-mode .opt-row.wrong { background: rgba(239, 68, 68, 0.2); }
      
      .opt-row.missed { border-color: var(--warning); border-style: dashed; }
      .opt-row.missed .opt-icon { background: var(--warning); border-color: var(--warning); color: white; }

      .opt-text { flex: 1; font-size: calc(var(--content-font-size) - 0.05rem); line-height: 1.6; color: var(--text-main); font-weight: 500; }

      .answer-section { margin-top: 25px; padding: 20px; background: var(--bg-body); border-radius: 10px; display: none; border: 1px solid var(--border-color); }
      .answer-section.show { display: block; animation: slideDown 0.3s; }
      
      .note-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border-color); }
      .note-label { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 5px; display: flex; justify-content: space-between; }
      .note-textarea { width: 100%; min-height: 60px; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); font-family: inherit; resize: vertical; font-size: 0.95rem; }
      .note-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1); }

      .action-bar { background: var(--bg-card); border-top: 1px solid var(--border-color); padding: 15px 20px; padding-bottom: max(15px, var(--safe-bottom)); display: flex; gap: 15px; align-items: center; position: fixed; bottom: 0; width: calc(100% - var(--sidebar-width)); z-index: 40; transition: width 0.3s; }
      .btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
      .btn:active { transform: scale(0.98); }
      .btn-secondary { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-color); }
      .btn-primary { background: var(--primary); color: white; flex: 2; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }
      .btn-recite { background: var(--info); color: white; flex: 2; }
      .btn-kill { background: #10b981; color: white; flex: 1; font-size: 0.9rem; }
      /* æŒæ¡æŒ‰é’®æ ·å¼ */
      .btn-master { background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 10px; display: inline-flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3); }
      .btn-master:active { transform: scale(0.95); }

      .btn-audio { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-color); width: 50px; flex: none; font-size: 1.3rem; }
      .btn-audio.active { background: var(--info); color: white; border-color: var(--info); animation: pulse-audio 1.5s infinite; }
      @keyframes pulse-audio { 0% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); } 100% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); } }

      .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; z-index: 200; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
      .toast.show { opacity: 1; }

      .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; text-align: center; border: 1px solid var(--border-color); color: var(--text-main); max-height: 80vh; overflow-y: auto; }
      .modal h2 { margin-top: 0; color: var(--primary); }
      .overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 45; display: none; }
      
      .stats-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
      .stats-table th, .stats-table td { padding: 8px; border-bottom: 1px solid var(--border-color); text-align: left; }
      .stats-table th { background: var(--bg-body); color: var(--text-sub); }
      .stats-score { font-weight: bold; }
      .score-high { color: var(--success); }
      .score-mid { color: var(--warning); }
      .score-low { color: var(--error); }
      
      .history-bar-container { display: flex; align-items: flex-end; height: 100px; gap: 8px; padding-top: 20px; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); }
      .history-bar { flex: 1; background: var(--primary); border-radius: 4px 4px 0 0; position: relative; min-height: 2px; transition: height 0.5s; opacity: 0.7; }
      .history-bar:hover { opacity: 1; }
      .history-val { position: absolute; top: -20px; width: 100%; text-align: center; font-size: 0.7rem; color: var(--text-sub); }
      .history-label { font-size: 0.7rem; color: var(--text-sub); text-align: center; overflow: hidden; white-space: nowrap; }

      #fileInput { display: none; }

      @media (max-width: 768px) {
        .sidebar { position: fixed; left: -100%; height: 100%; width: 85%; box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2); }
        .sidebar.open { left: 0; }
        .menu-toggle { display: block; }
        .overlay.active { display: block; }
        .action-bar { width: 100%; }
        .content-area { padding: 15px; padding-bottom: 80px; }
        .card { padding: 20px; width: 100%; }
      }
      @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <div class="toast" id="toast">æç¤ºä¿¡æ¯</div>
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="app-brand">
            <span>âš¡ï¸ é©¬åŸå†³æˆ˜ç‰ˆ</span>
            <span style="font-size:0.7rem; background:var(--error); color:white; padding:2px 4px; border-radius:4px;">è€ƒå‰4å¤©</span>
        </div>
        
        <div class="study-stats-card">
            <div class="stats-row">
                <span>â±ï¸ æœ¬æ¬¡å¤ä¹ </span>
                <span class="stats-val" id="sessionTimer">00:00</span>
            </div>
            <div class="stats-row" style="margin-top:5px">
                <span>ğŸ¯ ä»Šæ—¥ç›®æ ‡</span>
                <span class="stats-val" id="dailyGoalText">0/50</span>
            </div>
            <div class="daily-progress">
                <div class="daily-bar" id="dailyGoalBar"></div>
            </div>
        </div>

        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" class="search-input" placeholder="æœç´¢é¢˜ç›®..." oninput="handleSearch(this.value)">
        </div>
        <div class="countdown-card" onclick="editExamDate()" title="ç‚¹å‡»ä¿®æ”¹æ—¥æœŸ">
            <div style="font-size:0.75rem; opacity:0.9">âš ï¸ è·ç¦»è€ƒè¯•ä»…å‰©</div>
            <div style="margin:2px 0">
                <span class="countdown-num" id="daysLeft">--</span> å¤©
            </div>
            <div style="font-size:0.7rem; opacity:0.8" id="examDateStr">ç”Ÿæ­»æ—¶é€Ÿï¼</div>
        </div>
        <div class="func-grid">
            <button class="func-btn active" onclick="switchModule('main')" id="btn-main">ğŸ“– ç« èŠ‚ç»ƒä¹ </button>
            <button class="func-btn btn-recite" onclick="toggleReciteMode()" id="btn-recite">ğŸ“— èƒŒè¯µæ¨¡å¼</button>
        </div>
        <div class="func-grid">
            <button class="func-btn btn-wrong" onclick="switchModule('wrong_book')" id="btn-wrong">âŒ é”™é¢˜æœ¬ <span id="wrongCount">0</span></button>
            <button class="func-btn btn-fav" onclick="switchModule('favorites')" id="btn-fav">â­ æ”¶è—å¤¹ <span id="favCount"></span></button>
        </div>
        <div class="func-grid">
            <button class="func-btn btn-mock" onclick="startMockExam()" id="btn-mock">ğŸ“ æ¨¡æ‹Ÿè€ƒ</button>
            <button class="func-btn" style="color:var(--info); border-color:var(--info)" onclick="showStatsModal()">ğŸ“Š è¯Šæ–­æŠ¥å‘Š</button>
        </div>
        <div style="padding: 5px 0; font-size: 0.8rem; color: var(--text-sub); display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ—¡ï¸ å·²æ–©é¢˜æ•°:</span>
            <span style="font-weight: bold; color: #10b981;" id="killCount">0</span>
        </div>
      </div>
      <div class="chapter-list" id="chapterList"></div>
      <div class="sidebar-footer">
          <button class="tool-btn" onclick="adjustFontSize(-0.1)"><span>A-</span><span>å­—å·</span></button>
          <button class="tool-btn" onclick="adjustFontSize(0.1)"><span>A+</span><span>å­—å·</span></button>
          <button class="tool-btn" onclick="toggleDarkMode()"><span>ğŸŒ™</span><span>å¤œé—´</span></button>
          <button class="tool-btn" onclick="exportData()"><span>ğŸ’¾</span><span>å¤‡ä»½</span></button>
      </div>
      <div style="padding:5px; text-align:center; background:var(--bg-sidebar); border-top:1px solid var(--border-color); display:flex; gap:5px;">
          <button class="tool-btn" style="flex:1; color:var(--error); border:none; background:transparent;" onclick="resetWrongBook()">ğŸ”¥ é‡ç½®é”™é¢˜</button>
          <button class="tool-btn" style="flex:1; color:var(--warning); border:none; background:transparent;" onclick="resetCurrentChapter()">â†» é‡ç½®æœ¬ç« </button>
      </div>
    </div>
    <div class="overlay" id="overlay" onclick="closeAll()"></div>
    <input type="file" id="fileInput" accept=".json" onchange="handleFileImport(this)">

    <!-- æˆç»©å• Modal -->
    <div class="modal" id="scoreModal">
        <h2>ğŸ‰ è€ƒè¯•ç»“æŸ</h2>
        <div style="font-size:3rem; font-weight:800; color:var(--primary); margin:10px 0" id="modalScore">0</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px">
            <div>âœ… æ­£ç¡®: <span id="modalCorrect">0</span></div>
            <div>âŒ é”™è¯¯: <span id="modalWrong">0</span></div>
        </div>
        
        <div id="historyChartArea" style="display:none; margin-bottom:15px; padding:10px; background:#f8fafc; border-radius:8px;">
            <div style="font-size:0.8rem; color:var(--text-sub); text-align:left; margin-bottom:5px;">ğŸ“ˆ å†å²æ¨¡è€ƒè¶‹åŠ¿</div>
            <div class="history-bar-container" id="historyBars"></div>
        </div>

        <div style="text-align:left; font-size:0.85rem; margin-bottom:5px; color:var(--text-sub)">é”™é¢˜ç´¢å¼•ï¼š</div>
        <div style="max-height:150px; overflow-y:auto; text-align:left; background:var(--bg-body); padding:10px; border-radius:8px; display:flex; flex-wrap:wrap; gap:5px; margin-bottom:15px;" id="modalWrongList"></div>
        <button class="btn btn-primary" onclick="closeModal()">å…³é—­å¹¶å¤ä¹ </button>
    </div>

    <!-- è¯Šæ–­æŠ¥å‘Š Modal -->
    <div class="modal" id="statsModal" style="max-width:500px;">
        <h2>ğŸ“Š è€ƒå‰è¯Šæ–­æŠ¥å‘Š</h2>
        <p style="font-size:0.85rem; color:var(--text-sub)">çº¢è‰²ä»£è¡¨æ­£ç¡®ç‡ä½äº60%ï¼Œè¯·é‡ç‚¹å¤ä¹ ï¼</p>
        <div style="max-height:400px; overflow-y:auto;">
            <table class="stats-table">
                <thead><tr><th>ç« èŠ‚</th><th>è¿›åº¦</th><th>æ­£ç¡®ç‡</th></tr></thead>
                <tbody id="statsTableBody"></tbody>
            </table>
        </div>
        <button class="btn btn-secondary" onclick="closeModal()" style="margin-top:15px; width:100%">å…³é—­</button>
    </div>

    <div class="main-content">
      <div class="exam-bar" id="examBar">
          <div>â³ <span id="examTimer">45:00</span></div>
          <button onclick="submitExam()" style="background:#ef4444; color:white; border:none; padding:5px 12px; border-radius:4px; cursor:pointer; font-weight:bold;">äº¤å·</button>
      </div>
      <div class="top-nav" id="normalNav">
        <div class="nav-row">
          <div style="display: flex; align-items: center; overflow: hidden; gap:10px;">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            <div class="nav-title" id="headerTitle">åŠ è½½ä¸­...</div>
            <button class="jump-unfinished-btn" onclick="jumpToUnfinished()" title="ç»§ç»­åšé¢˜/èƒŒè¯µ" id="jumpBtn">â­ï¸ ç»§ç»­</button>
          </div>
          <div style="display:flex; align-items:center; gap:8px">
              <div id="reciteBadge" style="display:none; background:var(--info); color:white; font-size:0.75rem; padding:2px 6px; border-radius:4px;">èƒŒè¯µ</div>
              <div id="audioBadge" style="display:none; background:var(--success); color:white; font-size:0.75rem; padding:2px 6px; border-radius:4px;">ğŸ”Š å¬é¢˜ä¸­</div>
              <select class="jump-box" id="qJumper" onchange="jumpTo(this.value)" disabled><option>0/0</option></select>
          </div>
        </div>
        <div class="filter-scroll" id="filterBar">
          <button class="filter-chip active" onclick="setFilter('all')">â™¾ï¸ å…¨éƒ¨</button>
          <button class="filter-chip" onclick="setFilter('wrong')">âŒ é”™é¢˜</button>
          <button class="filter-chip auto-next-chip" id="autoNextBtn" onclick="toggleAutoNext()">âš¡ï¸ è¿å¯¹è‡ªåŠ¨è·³</button>
          
          <button class="filter-chip" onclick="setFilter('å•é€‰')">ğŸ”´ å•é€‰</button>
          <button class="filter-chip" onclick="setFilter('å¤šé€‰')">ğŸ”µ å¤šé€‰</button>
          <button class="filter-chip" id="killFilter" onclick="setFilter('kill')" style="display:none">ğŸ—¡ï¸ å·²æ–©</button>
          
          <button class="filter-chip" id="cleanModeBtn" onclick="toggleCleanMode()" style="display:none">ğŸ§¹ æç®€</button>
          <button class="filter-chip" id="speedModeBtn" onclick="toggleSpeedMode()" style="display:none">ğŸš€ æé€Ÿ</button>

          <button class="filter-chip func-action" id="shuffleBtn" onclick="shuffleWrong()" style="display:none">ğŸ² ä¹±åº</button>
          <button class="filter-chip func-action" id="exportBtn" onclick="exportWrong()" style="display:none">ğŸ“‹ å¯¼å‡º</button>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
      </div>
      <div class="content-area" id="qContainer">
        <div style="text-align: center; margin-top: 100px; color: var(--text-sub)">
            <div style="font-size:2rem; margin-bottom:10px">â³</div>
            <p>ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</p>
        </div>
      </div>
      <div class="action-bar" id="actionBar">
        <button class="btn btn-audio" id="ttsBtn" onclick="toggleTTS()" title="å¬é¢˜æ¨¡å¼">ğŸ§</button>
        <button class="btn btn-secondary" onclick="move(-1)">â¬…ï¸ ä¸Šä¸€é¢˜</button>
        <button class="btn btn-kill" id="killBtn" onclick="toggleKill()" style="display:none">ğŸ—¡ï¸ æ–©é¢˜</button>
        <button class="btn btn-primary" id="mainBtn" onclick="handleMainAction()">âœ… æäº¤ç­”æ¡ˆ</button>
        <button class="btn btn-secondary" onclick="move(1)">ä¸‹ä¸€é¢˜ â¡ï¸</button>
      </div>
    </div>

    <script>
      const modules = {
        main: { name: "ç« èŠ‚ç»ƒä¹ ", data: [], prefix: "ma_" },
        wrong_book: { name: "é”™é¢˜é›†", data: [], prefix: "wb_" },
        random_drill: { name: "ä¹±åºåˆ·é¢˜", data: [], prefix: "rd_" },
        favorites: { name: "æ”¶è—å¤¹", data: [], prefix: "fav_" },
        mock: { name: "æ¨¡æ‹Ÿè€ƒè¯•", data: [], prefix: "mock_" },
        search: { name: "æœç´¢ç»“æœ", data: [], prefix: "search_" }
      };

      let curMod = "main";
      let curChapter = "";
      let rawList = []; 
      let filteredList = [];
      let curIndex = 0; 
      let filterType = "all";
      let userSel = new Set(); 
      let wrongSet = new Set(); 
      let favSet = new Set();
      let killSet = new Set(); 
      let reciteProgress = {}; 
      let isReciteMode = false;
      let isExamMode = false;
      let examInterval = null;
      let examSeconds = 0;
      let currentFontSize = 1.35; 
      
      let isCleanMode = false; 
      let isSpeedMode = false; 
      let speedRevealed = false; 
      
      let isTTSActive = false;
      let ttsSynth = window.speechSynthesis;
      let ttsUtterance = null;
      let autoPlayNextTimer = null;

      let sessionSeconds = 0;
      let dailyGoal = 50;
      let dailyCount = 0;
      let isAutoNext = false; 

      // æ–°å¢ï¼šé¢˜ç›®ç»Ÿè®¡æ•°æ®ç¼“å­˜
      let questionStats = JSON.parse(localStorage.getItem("question_stats") || "{}");

      window.onload = async function() {
        initDarkMode();
        initCountdown();
        initFontMemory(); 
        startSessionTimer(); 
        loadDailyGoal(); 

        const savedFavs = localStorage.getItem("favorites");
        if (savedFavs) favSet = new Set(JSON.parse(savedFavs));
        const savedKills = localStorage.getItem("kill_questions");
        if (savedKills) killSet = new Set(JSON.parse(savedKills));
        const savedRecite = localStorage.getItem("recite_progress");
        if (savedRecite) reciteProgress = JSON.parse(savedRecite);
        
        if(localStorage.getItem("auto_next") === "true") {
            isAutoNext = true;
            document.getElementById("autoNextBtn").classList.add("active");
        }

        try {
            const response = await fetch('./æå–ç»“æœ_å¸¦ç­”æ¡ˆ.md');
            if(response.ok) {
                const text = await response.text();
                modules.main.data = parseMarkdown(text);
                recalcGlobalStats(); 
                switchModule('main');
                const lastChap = localStorage.getItem("last_chapter");
                if (lastChap) loadChapter(lastChap);
            } else {
                throw new Error("æ— æ•°æ®");
            }
        } catch(e) {
             const cached = localStorage.getItem("cached_questions");
             if(cached) {
                modules.main.data = JSON.parse(cached);
                recalcGlobalStats();
                switchModule('main');
             } else {
                document.getElementById("qContainer").innerHTML = `<div style="text-align:center; margin-top:50px;"><h3>âš ï¸ é¢˜åº“åŠ è½½å¤±è´¥</h3><p>è¯·ç¡®è®¤ç›®å½•ä¸‹å­˜åœ¨ <code>æå–ç»“æœ_å¸¦ç­”æ¡ˆ.md</code></p></div>`;
             }
        }
        
        document.addEventListener('keydown', (e) => {
            if(e.key === 'ArrowLeft') move(-1);
            if(e.key === 'ArrowRight') move(1);
            if(e.key === 'Enter') {
                if (isSpeedMode && !speedRevealed) revealSpeedAnswer();
                else if (!isReciteMode) handleMainAction();
            }
        });
      };

      // ç»Ÿè®¡åŠŸèƒ½å‡½æ•°
      function updateQuestionStats(uid, isCorrect) {
          if(!questionStats[uid]) questionStats[uid] = { correct: 0, wrong: 0 };
          if(isCorrect) questionStats[uid].correct++;
          else questionStats[uid].wrong++;
          localStorage.setItem("question_stats", JSON.stringify(questionStats));
      }

      function getStatsHtml(uid) {
          const s = questionStats[uid] || { correct: 0, wrong: 0 };
          const total = s.correct + s.wrong;
          return `
            <div class="stats-badge" title="åšå¯¹/åšé”™/æ€»æ¬¡æ•°">
                <span class="stats-val-c">âœ“${s.correct}</span>
                <span class="stats-val-w" style="margin-left:4px">âœ—${s.wrong}</span>
                <span style="margin-left:4px;opacity:0.6">ğŸ“¦${total}</span>
            </div>
          `;
      }

      function recalcGlobalStats() {
          wrongSet.clear();
          let globalWrongCount = 0;
          const chapMap = new Map();
          modules.main.data.forEach(q => { 
              if(!chapMap.has(q.chapter)) chapMap.set(q.chapter, []); 
              chapMap.get(q.chapter).push(q); 
          });

          for (const [chapName, questions] of chapMap) {
             const key = "ma_" + chapName;
             const savedJson = localStorage.getItem(key);
             if(!savedJson) continue;
             try {
                 const savedState = JSON.parse(savedJson);
                 savedState.forEach((state, i) => {
                     if (state && state.done && questions[i]) {
                         const q = questions[i];
                         const tempQ = { answer: q.answer, userSel: new Set(state.sel) };
                         if(checkStatus(tempQ) !== 'correct') {
                             wrongSet.add(q._uid);
                             globalWrongCount++;
                         }
                     }
                 });
             } catch(e) {}
          }
          document.getElementById("wrongCount").innerText = globalWrongCount;
          document.getElementById("favCount").innerText = favSet.size;
          document.getElementById("killCount").innerText = killSet.size;
      }

      function parseMarkdown(text) {
        const lines = text.split(/\r?\n/);
        const questions = [];
        let currentChapter = "é»˜è®¤ç« èŠ‚";
        let currentType = "å•é€‰é¢˜"; 
        let tempQ = null;
        let qIndexCounter = 0; // æ ¸å¿ƒä¿®å¤ï¼šå¼•å…¥å…¨å±€è®¡æ•°å™¨ï¼Œç¡®ä¿IDç»å¯¹å”¯ä¸€
        
        const saveQuestion = () => {
           if (tempQ) {
               const bracketRegex = /([ï¼ˆ(])\s*([A-Ea-e]+)\s*([)ï¼‰])/;
               const inlineAns = tempQ.content.match(bracketRegex);
               if (inlineAns) {
                   if (!tempQ.answer) tempQ.answer = inlineAns[2].toUpperCase().trim();
                   tempQ.content = tempQ.content.replace(bracketRegex, "ï¼ˆ ï¼‰");
               }
               if (tempQ.answer && tempQ.answer.length > 1) tempQ.type = "å¤šé€‰é¢˜";
               else if (!tempQ.type) tempQ.type = currentType;
               
               const str = tempQ.chapter + tempQ.content.substring(0, 15);
               let hash = 0;
               for (let i = 0; i < str.length; i++) hash = (hash << 5) - hash + str.charCodeAt(i);
               // æ ¸å¿ƒä¿®å¤ï¼šUIDå¢åŠ è®¡æ•°åç¼€ï¼Œå½»åº•è§£å†³é‡å¤é¢˜ç›®IDå†²çªé—®é¢˜
               tempQ._uid = `q_${Math.abs(hash)}_${qIndexCounter++}`;
               questions.push(tempQ);
           }
        };

        for (let line of lines) {
            line = line.trim();
            if (!line) continue;
            if (line.includes("å•é¡¹é€‰æ‹©") || line.includes("å•é€‰")) currentType = "å•é€‰é¢˜";
            if (line.includes("å¤šé¡¹é€‰æ‹©") || line.includes("å¤šé€‰") || line.includes("ä¸å®šé¡¹")) currentType = "å¤šé€‰é¢˜";

            if (line.match(/^##\s+/)) {
                saveQuestion();
                currentChapter = line.replace(/^##\s+/, '').trim();
                tempQ = null;
                continue;
            }
            const qMatch = line.match(/^(\d+)[\.ï¼ã€\s]\s*(.+)/);
            const isOptionStart = /^[A-Ea-e][\.ï¼ã€\s]/.test(line);
            
            if (qMatch && !isOptionStart) {
                saveQuestion();
                tempQ = { chapter: currentChapter, type: currentType, content: qMatch[2].trim(), options: [], answer: "", userSel: new Set(), isSubmitted: false };
                continue;
            }
            if ((isOptionStart || line.match(/^[A-Ea-e]\s+/)) && tempQ) {
                const optRegex = /([A-Ea-e])[\.ï¼ã€\s]\s*([\s\S]*?)(?=\s+[A-Ea-e][\.ï¼ã€\s]|$)/g;
                let match;
                let found = false;
                while ((match = optRegex.exec(line)) !== null) {
                    found = true;
                    tempQ.options.push({ label: match[1].toUpperCase(), text: match[2].trim() });
                }
                if (!found) {
                     const simpleMatch = line.match(/^([A-Ea-e])[\.ï¼ã€\s]\s*([\s\S]+)/);
                     if(simpleMatch) tempQ.options.push({ label: simpleMatch[1].toUpperCase(), text: simpleMatch[2].trim() });
                     else if (tempQ.options.length > 0) tempQ.options[tempQ.options.length-1].text += "\n" + line;
                }
                continue;
            }
            const ansMatch = line.match(/ã€ç­”æ¡ˆã€‘\s*([A-Za-z\s,ï¼Œ]+)/);
            if (ansMatch && tempQ) tempQ.answer = ansMatch[1].toUpperCase().replace(/[^A-Z]/g, ''); 
        }
        saveQuestion();
        return questions;
      }

      function getQuestionType(q) {
          if (q.type && (q.type.includes("å¤š") || q.type.includes("ä¸å®šé¡¹"))) return 'multi';
          if (q.answer && q.answer.length > 1) return 'multi';
          return 'single';
      }

      function renderQ() {
        stopTTS(); 
        if (!filteredList.length) {
            document.getElementById("qContainer").innerHTML = `<div style="text-align:center;margin-top:50px;color:var(--text-sub)">æ— ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®<br><span style="font-size:0.8rem">å¤ªæ£’äº†ï¼Œå…¨éƒ¨æ¶ˆç­ï¼</span></div>`;
            return;
        }
        
        if (curIndex >= filteredList.length) curIndex = filteredList.length - 1;
        
        const q = filteredList[curIndex];
        userSel = new Set(q.userSel);
        
        document.getElementById("headerTitle").innerText = isExamMode ? "æ¨¡æ‹Ÿè€ƒè¯•ä¸­..." : curChapter;
        document.getElementById("qJumper").value = curIndex;
        
        document.getElementById("reciteBadge").style.display = isReciteMode ? "block" : "none";
        document.getElementById("killFilter").style.display = isReciteMode ? "flex" : "none";
        document.getElementById("cleanModeBtn").style.display = isReciteMode ? "flex" : "none";
        document.getElementById("speedModeBtn").style.display = isReciteMode ? "flex" : "none";
        
        const isWrongMode = (curMod === 'wrong_book');
        document.getElementById("shuffleBtn").style.display = isWrongMode ? "flex" : "none";
        document.getElementById("exportBtn").style.display = isWrongMode ? "flex" : "none";
        
        const progress = Math.round(((curIndex + 1) / filteredList.length) * 100);
        const pBar = document.getElementById('progressBar');
        pBar.style.width = `${progress}%`;
        if(isReciteMode) pBar.classList.add('recite-bar'); else pBar.classList.remove('recite-bar');

        const container = document.getElementById("qContainer");
        let cardClass = "card";
        if (isReciteMode) {
            cardClass += " recite-mode";
            if (isCleanMode) cardClass += " clean-mode";
            if (isSpeedMode) cardClass += " speed-mode";
        }
        else if (curMod === 'wrong_book') cardClass += " wrong-mode";
        else if (curMod === 'favorites') cardClass += " fav-mode";
        else if (isExamMode) cardClass += " mock-mode";
        else if (curMod === 'search') cardClass += " search-mode";
        
        const isKilled = killSet.has(q._uid);
        if (isKilled) cardClass += " mastered-card";

        const mBtn = document.getElementById("mainBtn");
        const kBtn = document.getElementById("killBtn");
        
        if (isReciteMode) {
            mBtn.innerText = "ä¸‹ä¸€é¢˜ â¡ï¸"; mBtn.className = "btn btn-recite"; mBtn.onclick = () => move(1);
            kBtn.style.display = "flex";
            kBtn.innerText = isKilled ? "â†©ï¸ æ¢å¤" : "ğŸ—¡ï¸ æ–©é¢˜";
            kBtn.style.background = isKilled ? "#64748b" : "#10b981";
        } else if (q.isSubmitted) {
            mBtn.innerText = curIndex < filteredList.length - 1 ? "ä¸‹ä¸€é¢˜ â¡ï¸" : "æœ¬ç« å®Œæˆ";
            mBtn.className = "btn btn-primary"; mBtn.onclick = handleMainAction;
            kBtn.style.display = "none";
        } else {
            mBtn.innerText = "âœ… æäº¤ç­”æ¡ˆ"; mBtn.className = "btn btn-primary"; mBtn.onclick = handleMainAction;
            kBtn.style.display = "none";
        }
        if (isExamMode) {
            mBtn.innerText = curIndex < filteredList.length - 1 ? "ä¸‹ä¸€é¢˜ â¡ï¸" : "å®Œæˆ";
            mBtn.className = "btn btn-secondary"; mBtn.onclick = () => move(1);
        }

        const type = getQuestionType(q);
        const typeLabel = type === 'multi' ? "å¤šé€‰é¢˜" : "å•é€‰é¢˜";
        const typeClass = type === 'multi' ? "q-type multi" : "q-type single";
        const isFav = favSet.has(q._uid);
        const starHtml = `<span class="star-icon ${isFav?'active':''}" onclick="toggleFav('${q._uid}')">â­</span>`;
        const chapterHtml = `<span class="chapter-tag" title="${q.chapter}">${q.chapter}</span>`;
        const masteredHtml = isKilled ? `<div class="mastered-badge">å·²æ–©æ€</div>` : '';
        const statsHtml = getStatsHtml(q._uid); // ç”Ÿæˆç»Ÿè®¡è§’æ ‡

        let contentHtml = q.content;

        let optsHtml = "";
        const correctSet = new Set((q.answer || "").toUpperCase().split(""));
        
        if (isReciteMode && isSpeedMode) {
            speedRevealed = false;
            optsHtml = `
            <div class="opts-container" id="speedOpts" style="display:none;">
                ${generateOptsHtml(q, type, correctSet)}
            </div>
            <div class="speed-answer-area" id="speedArea" onclick="revealSpeedAnswer()">
                âš¡ï¸ ç‚¹å‡»æ˜¾ç¤ºç­”æ¡ˆ
            </div>`;
        } else {
            optsHtml = `<div class="opts-container">${generateOptsHtml(q, type, correctSet)}</div>`;
        }

        const showAns = isReciteMode || (!isExamMode && q.isSubmitted);
        let reciteInfo = isReciteMode ? `<div style="margin-top:10px; font-size:0.8rem; color:var(--info); text-align:right;">è¿›åº¦: ${curIndex + 1} / ${filteredList.length}</div>` : "";
        
        const myNote = localStorage.getItem(`note_${q._uid}`) || "";
        
        // é”™é¢˜æœ¬ä¸“ç”¨ï¼šæ‰‹åŠ¨ç§»é™¤æŒ‰é’®
        let masterBtnHtml = "";
        if (curMod === 'wrong_book' && q.isSubmitted) {
            masterBtnHtml = `<button class="btn-master" onclick="manualMaster('${q._uid}')">ğŸ“ æˆ‘å­¦ä¼šäº† (ç§»é™¤)</button>`;
        }

        container.innerHTML = `
          <div class="${cardClass}">
             ${masteredHtml}
             <div class="q-header">
                <div style="display:flex; align-items:center;">
                    <span class="${typeClass}">${typeLabel}</span>
                    ${chapterHtml}
                    ${starHtml}
                </div>
                ${statsHtml} <!-- æ’å…¥ç»Ÿè®¡ -->
             </div>
             <div style="font-size:0.8rem; color:var(--text-sub); text-align:right; margin-bottom:15px; margin-top:-10px">
                ${curIndex + 1} / ${filteredList.length}
             </div>
             <div class="q-content">${contentHtml}</div>
             ${optsHtml}
             <div class="answer-section ${showAns ? "show" : ""}" id="ansPanel">
                <div style="margin-bottom:10px;">
                   <span style="font-weight:bold; color:var(--text-main)">å‚è€ƒç­”æ¡ˆï¼š</span>
                   <span style="color:var(--primary); font-weight:bold; font-size:1.4rem">${q.answer || "ç•¥"}</span>
                </div>
                ${masterBtnHtml} <!-- æ’å…¥æ‰‹åŠ¨ç§»é™¤æŒ‰é’® -->
                ${reciteInfo}
             </div>
             <div class="note-section">
                <div class="note-label"><span>ğŸ“ ä¸ªäººç¬”è®°</span><span style="font-size:0.75rem;opacity:0.6" id="saveStatus"></span></div>
                <textarea class="note-textarea" placeholder="åœ¨æ­¤è®°å½•å£è¯€ã€å‘ç‚¹æˆ–å¿ƒå¾—..." onblur="saveNote('${q._uid}', this.value)" oninput="document.getElementById('saveStatus').innerText='è¾“å…¥ä¸­...'">${myNote}</textarea>
             </div>
          </div>
        `;
        
        if(isTTSActive) { setTimeout(speakCurrentQuestion, 500); }
      }
      
      function generateOptsHtml(q, type, correctSet) {
          if (!q.options || q.options.length === 0) return `<div style="padding:10px; color:var(--text-sub)">(æš‚æ— é€‰é¡¹)</div>`;
          return q.options.map(opt => {
              let cls = `opt-row ${type === 'multi' ? 'multi-mode' : 'single-mode'}`;
              if (isReciteMode) {
                  if (correctSet.has(opt.label)) cls += " correct";
              } else if (isExamMode) {
                  if (userSel.has(opt.label)) cls += " selected";
              } else if (q.isSubmitted) {
                  if (correctSet.has(opt.label)) {
                      cls += " correct";
                      if (!userSel.has(opt.label)) cls += " missed";
                  } else if (userSel.has(opt.label)) cls += " wrong";
              } else {
                  if (userSel.has(opt.label)) cls += " selected";
              }
              let optTextHtml = opt.text;
              return `
             <div class="${cls}" onclick="handleOpt('${opt.label}')">
               <div class="opt-icon">${opt.label}</div>
               <div class="opt-text">${optTextHtml}</div>
             </div>`;
          }).join("");
      }

      window.saveNote = function(uid, content) {
          localStorage.setItem(`note_${uid}`, content);
          const status = document.getElementById('saveStatus');
          if(status) {
              status.innerText = "å·²ä¿å­˜";
              status.style.color = "#10b981";
              setTimeout(() => status.innerText = "", 1500);
          }
      };

      window.toggleAutoNext = function() {
          isAutoNext = !isAutoNext;
          const btn = document.getElementById("autoNextBtn");
          if(isAutoNext) {
              btn.classList.add("active");
              localStorage.setItem("auto_next", "true");
              showToast("âš¡ï¸ å·²å¼€å¯ï¼šåšå¯¹è‡ªåŠ¨ä¸‹ä¸€é¢˜");
          } else {
              btn.classList.remove("active");
              localStorage.setItem("auto_next", "false");
          }
      };

      window.handleMainAction = function () {
        if(isExamMode) { move(1); return; }
        
        const q = filteredList[curIndex];
        if (q.isSubmitted) { move(1); return; } 

        q.isSubmitted = true;
        incrementDailyGoal();
        
        const status = checkStatus(q);
        const isCorrect = (status === 'correct');
        
        // æ ¸å¿ƒæ›´æ–°ï¼šæ›´æ–°ç»Ÿè®¡æ•°æ®
        updateQuestionStats(q._uid, isCorrect);

        // æ ¸å¿ƒé€»è¾‘ä¿®æ”¹ï¼šé”™é¢˜æœ¬æ¨¡å¼ä¸‹ï¼Œåšå¯¹äº†ä¸ç§»é™¤ï¼Œé™¤éæ‰‹åŠ¨
        if(curMod === 'wrong_book') {
            // å¦‚æœåšé”™äº†ï¼ŒåŒæ­¥ç»™åŸç« èŠ‚â€œé”™è¯¯â€çŠ¶æ€ï¼Œç¡®ä¿ä¸‹æ¬¡è¿˜åœ¨
            if(!isCorrect) {
                updateChapterStatus(q);
            }
            // å¦‚æœåšå¯¹äº†ï¼Œä¸æ›´æ–°åŸç« èŠ‚çŠ¶æ€ï¼ˆä¿æŒåŸç« èŠ‚é‡Œçš„â€œé”™è¯¯â€è®°å½•ï¼‰ï¼Œä»è€Œä¸è¢« recalcGlobalStats ç§»é™¤
            // ç•Œé¢ä¸Šæ­£å¸¸æ˜¾ç¤ºè§£æå’Œâ€œæˆ‘å­¦ä¼šäº†â€æŒ‰é’®
            renderQ();
            updateJumperOption(curIndex, status);
        } else {
            // æ­£å¸¸æ¨¡å¼ï¼ŒåŒæ­¥çŠ¶æ€
            updateChapterStatus(q);
            recalcGlobalStats(); // å®æ—¶åˆ·æ–°ä¾§è¾¹æ æ•°å­—
            
            renderQ();
            updateJumperOption(curIndex, status);
            
            if(isAutoNext && isCorrect) {
                setTimeout(() => { if(filteredList[curIndex]._uid === q._uid) move(1); }, 800); 
            }
        }
      };

      // æ–°å¢ï¼šæ‰‹åŠ¨ä»é”™é¢˜æœ¬ç§»é™¤
      window.manualMaster = function(uid) {
          // 1. æ‰¾åˆ°è¯¥é¢˜
          const q = filteredList.find(i => i._uid === uid);
          if(!q) return;
          
          // ç§»é™¤ç¡®è®¤å¼¹çª—ï¼Œç›´æ¥æ‰§è¡Œ
          
          // 2. å¼ºåˆ¶æ›´æ–°åŸç« èŠ‚çŠ¶æ€ä¸ºâ€œæ­£ç¡®â€ï¼Œè¿™æ · recalcGlobalStats å°±ä¼šæŠŠå®ƒè¸¢å‡ºé”™é¢˜é›†
          // ç¡®ä¿è§£æå‡ºæ¥çš„ç­”æ¡ˆç»å¯¹æ­£ç¡®
          const correctArr = (q.answer || "").toUpperCase().split("").filter(c => /[A-Z]/.test(c));
          q.userSel = new Set(correctArr); // è¦†ç›–ä¸ºæ­£ç¡®é€‰é¡¹
          q.isSubmitted = true; // ç¡®ä¿æ˜¯å·²æäº¤çŠ¶æ€
          
          updateChapterStatus(q);
          
          // 3. åˆ·æ–°å…¨å±€ç»Ÿè®¡
          recalcGlobalStats();
          
          // 4. ä»å½“å‰è§†å›¾ç§»é™¤
          showToast("ğŸ‰ å¤ªæ£’äº†ï¼å·²ç§»é™¤è¯¥é”™é¢˜");
          filteredList.splice(curIndex, 1);
          const rawIdx = rawList.findIndex(x => x._uid === uid);
          if(rawIdx > -1) rawList.splice(rawIdx, 1);
          
          if(curIndex >= filteredList.length) curIndex = filteredList.length - 1;
          
          if(filteredList.length === 0) {
             document.getElementById("qContainer").innerHTML = `<div style="text-align:center;margin-top:50px;">ğŸ‰ æ­å–œï¼é”™é¢˜æœ¬å·²æ¸…ç©º</div>`;
          } else {
             renderQ();
             initJumper();
          }
      };
      
      function updateChapterStatus(q) {
          const chapName = q.chapter;
          const key = "ma_" + chapName;
          let saved = JSON.parse(localStorage.getItem(key) || "[]");
          
          const chapQuestions = modules.main.data.filter(x => x.chapter === chapName);
          // æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ indexOf è€Œé findIndex(uid) æ¥é¿å…IDå†²çªæ—¶æ›´æ–°äº†é”™è¯¯çš„é¢˜ç›®
          const indexInChap = chapQuestions.indexOf(q);
          
          if (indexInChap !== -1) {
              while(saved.length <= indexInChap) saved.push(null);
              saved[indexInChap] = { 
                  sel: Array.from(q.userSel), 
                  done: true 
              };
              localStorage.setItem(key, JSON.stringify(saved));
          }
      }

      window.shuffleWrong = function() {
          if(filteredList.length < 2) return showToast("é¢˜ç›®å¤ªå°‘ï¼Œæ— éœ€ä¹±åº");
          filteredList.sort(() => Math.random() - 0.5);
          curIndex = 0;
          renderQ();
          showToast("ğŸ² é”™é¢˜å·²æ‰“ä¹±é¡ºåº");
      };

      window.exportWrong = function() {
          if(filteredList.length === 0) return showToast("æ²¡æœ‰é”™é¢˜å¯å¯¼å‡º");
          let text = "ğŸ“‹ æˆ‘çš„é”™é¢˜æœ¬å¯¼å‡º\n\n";
          filteredList.forEach((q, i) => {
              text += `${i+1}. [${q.chapter}] ${q.content}\n`;
              q.options.forEach(o => text += `   ${o.label}. ${o.text}\n`);
              text += `   æ­£ç¡®ç­”æ¡ˆ: ${q.answer}\n\n`;
          });
          
          const textArea = document.createElement("textarea");
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          try {
              document.execCommand('copy');
              showToast("âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ç›´æ¥ç²˜è´´æ‰“å°");
          } catch (err) {
              showToast("âŒ å¤åˆ¶å¤±è´¥");
          }
          document.body.removeChild(textArea);
      };

      function startSessionTimer() {
          setInterval(() => {
              sessionSeconds++;
              const m = Math.floor(sessionSeconds / 60).toString().padStart(2, '0');
              const s = (sessionSeconds % 60).toString().padStart(2, '0');
              document.getElementById("sessionTimer").innerText = `${m}:${s}`;
          }, 1000);
      }

      function loadDailyGoal() {
          const today = new Date().toLocaleDateString();
          const key = `daily_goal_${today}`;
          dailyCount = parseInt(localStorage.getItem(key) || "0");
          updateDailyUI();
      }

      function incrementDailyGoal() {
          dailyCount++;
          const today = new Date().toLocaleDateString();
          localStorage.setItem(`daily_goal_${today}`, dailyCount);
          updateDailyUI();
      }

      function updateDailyUI() {
          const pct = Math.min((dailyCount / dailyGoal) * 100, 100);
          document.getElementById("dailyGoalBar").style.width = `${pct}%`;
          document.getElementById("dailyGoalText").innerText = `${dailyCount}/${dailyGoal}`;
          if(dailyCount >= dailyGoal) {
              document.getElementById("dailyGoalBar").style.background = "#10b981";
          }
      }

      function initFontMemory() {
          const savedSize = localStorage.getItem("font_size");
          if(savedSize) {
              currentFontSize = parseFloat(savedSize);
              document.documentElement.style.setProperty('--content-font-size', currentFontSize + 'rem');
          }
      }

      window.adjustFontSize = function(delta) {
          currentFontSize += delta;
          if(currentFontSize < 0.8) currentFontSize = 0.8;
          if(currentFontSize > 2.5) currentFontSize = 2.5;
          document.documentElement.style.setProperty('--content-font-size', currentFontSize + 'rem');
          localStorage.setItem("font_size", currentFontSize); 
      };
      
      function saveExamHistory(score, correct, total) {
          const history = JSON.parse(localStorage.getItem("exam_history") || "[]");
          const dateStr = new Date().toLocaleDateString(); 
          history.push({ date: dateStr, score: score, correct: correct, total: total });
          if(history.length > 7) history.shift(); 
          localStorage.setItem("exam_history", JSON.stringify(history));
          renderHistoryChart(history);
      }

      function renderHistoryChart(history) {
          const container = document.getElementById("historyBars");
          container.innerHTML = "";
          if(history.length === 0) {
              document.getElementById("historyChartArea").style.display = "none";
              return;
          }
          document.getElementById("historyChartArea").style.display = "block";
          
          history.forEach(rec => {
              const bar = document.createElement("div");
              bar.className = "history-bar";
              const pct = (rec.score / (rec.total * 2)) * 100; 
              const height = Math.max(pct, 10) + "%"; 
              bar.style.height = height;
              bar.title = `${rec.date}: ${rec.score}åˆ†`;
              
              bar.innerHTML = `
                <div class="history-val">${rec.score}</div>
                <div style="position:absolute; bottom:-20px; width:100%; text-align:center; font-size:0.6rem; color:var(--text-sub)">${rec.date.split('/')[2]||'ä»Šå¤©'}</div>
              `;
              container.appendChild(bar);
          });
      }

      window.toggleCleanMode = function() {
          isCleanMode = !isCleanMode;
          const btn = document.getElementById("cleanModeBtn");
          if(isCleanMode) {
              btn.classList.add("active-clean");
              if(isSpeedMode) toggleSpeedMode(); 
              showToast("ğŸ§¹ å¹²æ‰°æ¶ˆé™¤å¼€å¯");
          } else {
              btn.classList.remove("active-clean");
          }
          renderQ();
      };
      
      window.toggleSpeedMode = function() {
          isSpeedMode = !isSpeedMode;
          const btn = document.getElementById("speedModeBtn");
          if(isSpeedMode) {
              btn.classList.add("active-speed");
              if(isCleanMode) toggleCleanMode();
              showToast("ğŸš€ æé€Ÿæ¨¡å¼å¼€å¯");
          } else {
              btn.classList.remove("active-speed");
          }
          renderQ();
      };
      
      window.revealSpeedAnswer = function() {
          const area = document.getElementById("speedArea");
          const opts = document.getElementById("speedOpts");
          const q = filteredList[curIndex];
          if(area && opts) {
              area.innerHTML = `æ­£ç¡®ç­”æ¡ˆ: ${q.answer}`;
              area.classList.add("revealed");
              opts.style.display = "flex";
              speedRevealed = true;
          }
      };

      window.toggleTTS = function() {
          isTTSActive = !isTTSActive;
          const btn = document.getElementById("ttsBtn");
          const badge = document.getElementById("audioBadge");
          if(isTTSActive) {
              btn.classList.add("active");
              badge.style.display = "block";
              showToast("ğŸ”Š å¬é¢˜æ¨¡å¼å¼€å¯");
              speakCurrentQuestion();
          } else {
              btn.classList.remove("active");
              badge.style.display = "none";
              stopTTS();
              showToast("ğŸ”‡ å¬é¢˜æ¨¡å¼å…³é—­");
          }
      };

      function stopTTS() {
          if(ttsSynth.speaking) ttsSynth.cancel();
          clearTimeout(autoPlayNextTimer);
      }

      function speakCurrentQuestion() {
          if(!isTTSActive) return;
          stopTTS();
          const q = filteredList[curIndex];
          let text = `ç¬¬${curIndex+1}é¢˜ã€‚${q.content}ã€‚`;
          q.options.forEach(opt => text += `${opt.label}ï¼Œ${opt.text}ã€‚`);
          if(isReciteMode || q.isSubmitted) text += `æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${q.answer}ã€‚`;

          ttsUtterance = new SpeechSynthesisUtterance(text);
          ttsUtterance.rate = 1.2;
          ttsUtterance.lang = 'zh-CN';
          ttsUtterance.onend = function() {
              if(isTTSActive && curIndex < filteredList.length - 1) {
                  autoPlayNextTimer = setTimeout(() => move(1), 1500); 
              }
          };
          ttsSynth.speak(ttsUtterance);
      }

      window.showStatsModal = function() {
          const statsMap = {}; 
          modules.main.data.forEach(q => {
              if(!statsMap[q.chapter]) statsMap[q.chapter] = { total:0, done:0, correct:0 };
              statsMap[q.chapter].total++;
          });
          
          for(let chap in statsMap) {
              const saved = JSON.parse(localStorage.getItem("ma_" + chap) || "[]");
              let doneCount = 0;
              let correctCount = 0;
              const chapQs = modules.main.data.filter(q => q.chapter === chap);
              
              saved.forEach((record, idx) => {
                  if(record && record.done && chapQs[idx]) {
                      doneCount++;
                      const tempQ = {answer: chapQs[idx].answer, userSel: new Set(record.sel)};
                      if(checkStatus(tempQ) === 'correct') correctCount++;
                  }
              });
              statsMap[chap].done = doneCount;
              statsMap[chap].correct = correctCount;
          }

          const tbody = document.getElementById("statsTableBody");
          tbody.innerHTML = "";
          for(let chap in statsMap) {
              const d = statsMap[chap];
              if(d.total === 0) continue;
              const progressRate = Math.round(d.done / d.total * 100);
              let correctRate = d.done > 0 ? Math.round(d.correct / d.done * 100) : 0;
              let scoreClass = "stats-score";
              if(d.done > 0) {
                  if(correctRate < 60) scoreClass += " score-low";
                  else if(correctRate < 85) scoreClass += " score-mid";
                  else scoreClass += " score-high";
              }
              tbody.innerHTML += `<tr><td>${chap}</td><td>${d.done}/${d.total} (${progressRate}%)</td><td class="${scoreClass}">${d.done>0 ? correctRate+"%" : "-"}</td></tr>`;
          }
          document.getElementById("statsModal").style.display = "block";
          document.getElementById("overlay").style.display = "block";
      };

      window.handleOpt = function (label) {
        if (isReciteMode) return; 
        const q = filteredList[curIndex];
        if (!isExamMode && q.isSubmitted) return;
        const type = getQuestionType(q);
        if (type === 'multi') {
          if (userSel.has(label)) userSel.delete(label); else userSel.add(label);
        } else {
          userSel.clear(); userSel.add(label);
        }
        q.userSel = new Set(userSel);
        renderQ();
      };
      
      window.toggleKill = function() {
          const q = filteredList[curIndex];
          if(killSet.has(q._uid)) {
              killSet.delete(q._uid);
              showToast("é¢˜ç›®å·²æ¢å¤");
          } else {
              killSet.add(q._uid);
              showToast("ğŸ—¡ï¸ æ–©æ€æˆåŠŸï¼ä¸‹æ¬¡è·³è¿‡");
          }
          localStorage.setItem("kill_questions", JSON.stringify(Array.from(killSet)));
          recalcGlobalStats();
          renderQ(); 
      };
      
      function showToast(msg) {
          const t = document.getElementById('toast');
          t.innerText = msg;
          t.classList.add('show');
          setTimeout(() => t.classList.remove('show'), 2000);
      }

      window.handleSearch = function(keyword) {
          if(!keyword) return;
          keyword = keyword.trim().toLowerCase();
          if(keyword.length < 1) return;
          if(isExamMode) { 
              if(!confirm("æœç´¢å°†é€€å‡ºè€ƒè¯•æ¨¡å¼ï¼Œç»§ç»­ï¼Ÿ")) { document.querySelector('.search-input').value = ""; return; }
              submitExam();
          }
          curMod = 'search';
          document.querySelectorAll('.func-btn').forEach(b => b.classList.remove('active'));
          rawList = modules.main.data.filter(q => q.content.toLowerCase().includes(keyword)).map(q => ({...q, userSel: new Set(), isSubmitted: false}));
          curChapter = `æœç´¢: "${keyword}"`;
          if(rawList.length === 0) {
              document.getElementById("qContainer").innerHTML = `<div style="text-align:center;margin-top:50px;color:var(--text-sub)">æœªæ‰¾åˆ°ç›¸å…³é¢˜ç›®</div>`;
              document.getElementById("headerTitle").innerText = curChapter;
              document.getElementById("qJumper").disabled = true;
          } else {
              setFilter('all');
          }
          if(window.innerWidth <= 768) closeAll();
      };

      window.jumpToUnfinished = function() {
          if (isReciteMode) {
               const lastIdx = reciteProgress[curChapter] || 0;
               if (curIndex === lastIdx) showToast("å½“å‰å·²åœ¨ä¸Šæ¬¡èƒŒè¯µä½ç½®");
               else { jumpTo(lastIdx); showToast(`å·²å›åˆ°ä¸Šæ¬¡è¿›åº¦`); }
          } else {
              const idx = filteredList.findIndex(q => !q.isSubmitted);
              if(idx !== -1) { jumpTo(idx); } else { alert("æœ¬é¡µé¢˜ç›®å·²å…¨éƒ¨å®Œæˆï¼"); }
          }
      };

      function initDarkMode() { if(localStorage.getItem("dark_mode") === "true") document.body.classList.add("dark-mode"); }
      window.toggleDarkMode = function() { document.body.classList.toggle("dark-mode"); localStorage.setItem("dark_mode", document.body.classList.contains("dark-mode")); };

      window.toggleReciteMode = function() {
          if (isExamMode) return alert("è€ƒè¯•ä¸­æ— æ³•åˆ‡æ¢æ¨¡å¼");
          isReciteMode = !isReciteMode;
          const btn = document.getElementById("btn-recite");
          
          if(isReciteMode) {
              btn.classList.add("active");
              if(curMod === 'main' && reciteProgress[curChapter] !== undefined) {
                  if(reciteProgress[curChapter] > 0 && reciteProgress[curChapter] < filteredList.length) {
                      curIndex = reciteProgress[curChapter];
                      showToast(`å·²å®šä½åˆ°ä¸Šæ¬¡èƒŒè¯µä½ç½®`);
                  }
              }
          } else {
              btn.classList.remove("active");
              stopTTS(); 
              isTTSActive = false;
              document.getElementById("ttsBtn").classList.remove("active");
              document.getElementById("audioBadge").style.display = "none";
              isCleanMode = false;
              isSpeedMode = false;
              document.getElementById("cleanModeBtn").classList.remove("active-clean");
              document.getElementById("speedModeBtn").classList.remove("active-speed");
          }
          renderQ();
          if(window.innerWidth <= 768) closeAll();
      };

      window.toggleFav = function(uid) {
          if (favSet.has(uid)) favSet.delete(uid); else favSet.add(uid);
          localStorage.setItem("favorites", JSON.stringify(Array.from(favSet)));
          recalcGlobalStats();
          renderQ();
      };

      window.startMockExam = function() {
          if(!confirm("å¼€å§‹45åˆ†é’Ÿå…¨çœŸæ¨¡æ‹Ÿè€ƒï¼Ÿ\n(30å•é€‰+10å¤šé€‰)")) return;
          isExamMode = true; isReciteMode = false; curMod = "mock";
          document.getElementById("btn-recite").classList.remove("active");
          const singles = modules.main.data.filter(q => getQuestionType(q) === 'single');
          const multis = modules.main.data.filter(q => getQuestionType(q) === 'multi');
          singles.sort(() => Math.random() - 0.5); multis.sort(() => Math.random() - 0.5);
          rawList = [...singles.slice(0, 30), ...multis.slice(0, 10)].map(q => ({...q, userSel: new Set(), isSubmitted: false}));
          filteredList = rawList; curIndex = 0;
          document.getElementById("normalNav").style.display = "none";
          document.getElementById("examBar").classList.add("active");
          document.getElementById("actionBar").style.display = "flex";
          closeAll(); renderQ();
          examSeconds = 45 * 60;
          examInterval = setInterval(() => {
              examSeconds--;
              const m = Math.floor(examSeconds / 60).toString().padStart(2,'0');
              const s = (examSeconds % 60).toString().padStart(2,'0');
              document.getElementById("examTimer").innerText = `${m}:${s}`;
              if(examSeconds <= 0) submitExam();
          }, 1000);
      };

      window.submitExam = function() {
          clearInterval(examInterval); isExamMode = false;
          document.getElementById("normalNav").style.display = "flex";
          document.getElementById("examBar").classList.remove("active");
          let score = 0, correct = 0, wrong = 0;
          let wrongIndices = [];
          rawList.forEach((q, idx) => {
              q.isSubmitted = true;
              if(checkStatus(q) === 'correct') {
                  score += (getQuestionType(q)==='single' ? 1 : 2);
                  correct++;
              } else {
                  wrong++;
                  wrongIndices.push(idx);
              }
          });
          
          saveExamHistory(score, correct, rawList.length);

          document.getElementById('modalScore').innerText = score;
          document.getElementById('modalCorrect').innerText = correct;
          document.getElementById('modalWrong').innerText = wrong;
          
          const list = document.getElementById('modalWrongList');
          list.innerHTML = "";
          wrongIndices.forEach(idx => {
              const span = document.createElement('span');
              span.className = 'chapter-tag';
              span.style.background = '#fef2f2';
              span.style.color = 'var(--error)';
              span.style.cursor = 'pointer';
              span.innerText = (idx + 1) + (getQuestionType(rawList[idx])==='single'?' (å•)':' (å¤š)');
              span.onclick = () => { closeModal(); jumpTo(idx); };
              list.appendChild(span);
          });
          
          document.getElementById('scoreModal').style.display = 'block';
          document.getElementById('overlay').style.display = 'block';
          renderQ();
      };
      
      window.closeModal = function() {
          document.getElementById('scoreModal').style.display = 'none';
          document.getElementById('statsModal').style.display = 'none';
          document.getElementById('overlay').style.display = 'none';
      }

      function checkStatus(q) {
          const correctArr = (q.answer || "").toUpperCase().split("").filter(c => /[A-Z]/.test(c));
          const correctSet = new Set(correctArr);
          let hasWrong = false;
          for (let s of q.userSel) { if (!correctSet.has(s)) { hasWrong = true; break; } }
          if (hasWrong) return 'wrong';
          if (q.userSel.size === correctSet.size) return 'correct';
          return 'partial';
      }

      function switchModule(key) {
        if(isExamMode) { alert("è¯·å…ˆäº¤å·"); return; }
        curMod = key;
        document.querySelectorAll('.func-btn').forEach(b => b.classList.remove('active'));
        if(key==='main') document.getElementById('btn-main').classList.add('active');
        if(key==='wrong_book') document.getElementById('btn-wrong').classList.add('active');
        if(key==='favorites') document.getElementById('btn-fav').classList.add('active');
        if(key==='random_drill') document.getElementById('btn-random').classList.add('active');

        if (key === 'wrong_book') {
            recalcGlobalStats(); 
            rawList = modules.main.data.filter(q => wrongSet.has(q._uid));
            curChapter = "é”™é¢˜æœ¬";
            rawList.forEach(q => { 
                q.userSel = new Set(); 
                q.isSubmitted = false; 
            });
        } else if (key === 'favorites') {
            rawList = modules.main.data.filter(q => favSet.has(q._uid));
            curChapter = "æ”¶è—å¤¹";
            rawList.forEach(q => { q.userSel = new Set(); q.isSubmitted = false; });
        } else if (key === 'random_drill') {
            rawList = [...modules.main.data].sort(() => Math.random() - 0.5).map(q => ({...q, userSel: new Set(), isSubmitted: false}));
            curChapter = "ä¹±åºåˆ·é¢˜";
        } else {
            initChapterList();
            document.getElementById("qContainer").innerHTML = `<div style="text-align:center; margin-top:100px; color:var(--text-sub)">ğŸ“‚ è¯·é€‰æ‹©ç« èŠ‚</div>`;
            document.getElementById("headerTitle").innerText = "ç« èŠ‚é€‰æ‹©";
            filteredList = [];
            if(window.innerWidth <= 768) toggleSidebar();
            return;
        }
        setFilter('all');
        if (window.innerWidth <= 768) closeAll();
      }

      function initChapterList() {
        const list = document.getElementById("chapterList");
        list.innerHTML = "";
        const map = new Map();
        modules.main.data.forEach(q => { if(!map.has(q.chapter)) map.set(q.chapter, 0); map.set(q.chapter, map.get(q.chapter)+1); });
        map.forEach((total, name) => {
             const key = "ma_" + name;
             const saved = JSON.parse(localStorage.getItem(key) || "[]");
             const done = saved.filter(x => x && x.done).length;
             
             const div = document.createElement("div");
             div.className = "chapter-item";
             if (name === curChapter && curMod === 'main') div.classList.add('active');
             
             const pillClass = done === total ? "badge-pill completed" : "badge-pill";
             div.innerHTML = `<span>${name}</span><span class="${pillClass}">${done}/${total}</span>`;
             div.onclick = () => loadChapter(name);
             list.appendChild(div);
        });
      }

      function loadChapter(name) {
          curChapter = name;
          curMod = 'main';
          localStorage.setItem("last_chapter", name);
          rawList = modules.main.data.filter(q => q.chapter === name);
          const saved = JSON.parse(localStorage.getItem("ma_" + name) || "[]");
          rawList.forEach((q, i) => {
              if(saved[i]) { q.userSel = new Set(saved[i].sel || []); q.isSubmitted = saved[i].done || false; } 
              else { q.userSel = new Set(); q.isSubmitted = false; }
          });
          setFilter('all');
          
          if(isReciteMode && reciteProgress[name] !== undefined) {
             let savedIdx = reciteProgress[name];
             if(savedIdx < 0) savedIdx = 0;
             if(savedIdx >= rawList.length) savedIdx = rawList.length - 1;
             curIndex = savedIdx;
             renderQ();
             showToast("å·²æ¢å¤èƒŒè¯µè¿›åº¦");
          }

          initChapterList();
          if (window.innerWidth <= 768) closeAll();
      }

      function setFilter(type) {
          filterType = type;
          document.querySelectorAll('.filter-chip').forEach(c => { 
              c.classList.remove('active'); 
              c.classList.remove('active-wrong');
              c.classList.remove('active-recite');
              c.classList.remove('active-kill');
              c.classList.remove('active-speed');
              c.classList.remove('active-clean');
          });
          
          if(event) {
              const el = event.target;
              if(type==='wrong') el.classList.add('active-wrong');
              else if(type==='kill') el.classList.add('active-kill');
              else if(isReciteMode && type !== 'kill') el.classList.add('active-recite');
              else if(type === 'all' || type === 'å•é€‰' || type === 'å¤šé€‰') el.classList.add('active');
          }

          if (type === 'all') filteredList = rawList;
          else if (type === 'wrong') filteredList = rawList.filter(q => q.isSubmitted && checkStatus(q) !== 'correct');
          else if (type === 'å•é€‰') filteredList = rawList.filter(q => getQuestionType(q) === 'single');
          else if (type === 'å¤šé€‰') filteredList = rawList.filter(q => getQuestionType(q) === 'multi');
          else if (type === 'kill') filteredList = rawList.filter(q => killSet.has(q._uid));
          
          curIndex = 0; initJumper(); renderQ();
      }

      function initJumper() {
          const sel = document.getElementById("qJumper");
          sel.innerHTML = "";
          sel.disabled = filteredList.length === 0;
          filteredList.forEach((q, i) => {
              let txt = `${i+1}. ${q.content.substring(0, 10)}...`;
              if (q.isSubmitted) { const s = checkStatus(q); txt += (s==='correct' ? 'âœ…' : (s==='partial'?'ğŸŒ—':'âŒ')); }
              sel.add(new Option(txt, i));
          });
      }
      
      function updateJumperOption(idx, status) {
          const sel = document.getElementById("qJumper");
          if(sel.options[idx]) {
              const q = filteredList[idx];
              const mark = status==='correct' ? 'âœ…' : (status==='partial' ? 'ğŸŒ—' : 'âŒ');
              sel.options[idx].text = `${idx+1}. ${q.content.substring(0, 10)}...${mark}`;
          }
      }

      window.move = (dir) => {
          const next = curIndex + dir;
          if (next >= 0 && next < filteredList.length) { 
              curIndex = next; 
              renderQ(); 
              if(isReciteMode && curMod === 'main') {
                  reciteProgress[curChapter] = curIndex;
                  localStorage.setItem("recite_progress", JSON.stringify(reciteProgress));
              }
          } 
          else { 
              if(dir===1) showToast("æœ¬ç« å·²ç»“æŸ"); 
              stopTTS(); 
          }
      };
      
      window.jumpTo = (v) => { curIndex = parseInt(v); renderQ(); };
      window.toggleSidebar = () => { document.getElementById("sidebar").classList.add("open"); document.getElementById("overlay").classList.add("active"); };
      window.closeAll = () => { document.getElementById("sidebar").classList.remove("open"); document.getElementById("overlay").classList.remove("active"); document.getElementById("scoreModal").style.display='none'; document.getElementById("statsModal").style.display='none'; };
      
      window.resetWrongBook = () => {
          if(!confirm("âš ï¸ ç¡®å®šè¦é‡ç½®æ‰€æœ‰é”™é¢˜å—ï¼Ÿ\n\nè¿™å°†æŠŠæ‰€æœ‰å·²åšé”™çš„é¢˜åœ¨åŸç« èŠ‚ä¸­æ ‡è®°ä¸ºâ€œæœªåšâ€ï¼Œæ¸…ç©ºæ‰€æœ‰è¿›åº¦ã€‚")) return;
          const chapMap = new Map();
          modules.main.data.forEach(q => { if(!chapMap.has(q.chapter)) chapMap.set(q.chapter, []); chapMap.get(q.chapter).push(q); });
          
          for (const [chapName, questions] of chapMap) {
              const key = "ma_" + chapName;
              const savedJson = localStorage.getItem(key);
              if(savedJson) {
                  let savedState = JSON.parse(savedJson);
                  let changed = false;
                  questions.forEach((q, i) => {
                      if(wrongSet.has(q._uid) && savedState[i]) {
                          savedState[i] = { sel: [], done: false }; // é‡ç½®ä¸ºæœªåš
                          changed = true;
                      }
                  });
                  if(changed) localStorage.setItem(key, JSON.stringify(savedState));
              }
          }
          recalcGlobalStats();
          if(curMod==='wrong_book') switchModule('main'); else renderQ();
          alert("é”™é¢˜å·²å…¨éƒ¨é‡ç½®ï¼");
      }

      window.resetCurrentChapter = function() {
          if(!confirm("ç¡®å®šè¦æ¸…ç©ºæœ¬ç« çš„æ‰€æœ‰è¿›åº¦å—ï¼Ÿ")) return;
          if(curMod !== 'main') return alert("è¯·å…ˆè¿›å…¥ç« èŠ‚ç»ƒä¹ æ¨¡å¼");
          rawList.forEach(q => { q.isSubmitted = false; q.userSel = new Set(); });
          localStorage.removeItem("ma_" + curChapter);
          
          if(reciteProgress[curChapter]) {
              delete reciteProgress[curChapter];
              localStorage.setItem("recite_progress", JSON.stringify(reciteProgress));
          }
          
          recalcGlobalStats();
          renderQ();
          initChapterList();
      }
      
      window.editExamDate = function() {
          const input = prompt("è®¾ç½®è€ƒè¯•æ—¥æœŸ (YYYY-MM-DD):", new Date().toISOString().slice(0,10));
          if(input) { const d = new Date(input); if(!isNaN(d)) { localStorage.setItem("exam_date", d.toISOString()); initCountdown(); } }
      }
      
      function initCountdown() {
          const target = localStorage.getItem("exam_date");
          let date = target ? new Date(target) : new Date(new Date().setDate(new Date().getDate() + 4));
          const diff = Math.ceil((date - new Date()) / (1000 * 60 * 60 * 24));
          document.getElementById("daysLeft").innerText = diff > 0 ? diff : 0;
          document.getElementById("examDateStr").innerText = `ç›®æ ‡: ${date.getMonth()+1}-${date.getDate()}`;
      }
      
      window.exportData = function() {
          const data = { timestamp: new Date().toISOString(), localStorage: { ...localStorage } };
          const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = `Mayuan_Backup_${new Date().toLocaleDateString()}.json`;
          a.click(); URL.revokeObjectURL(url);
      };
      
      window.importData = function() { document.getElementById("fileInput").click(); };
      window.handleFileImport = function(input) {
          const file = input.files[0];
          if(!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
              try {
                  const data = JSON.parse(e.target.result);
                  if(data.localStorage) {
                      if(confirm("æ¢å¤æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰è¿›åº¦ï¼Œç¡®å®šå—ï¼Ÿ")) {
                          localStorage.clear();
                          Object.keys(data.localStorage).forEach(k => { localStorage.setItem(k, data.localStorage[k]); });
                          alert("æ•°æ®æ¢å¤æˆåŠŸ"); location.reload();
                      }
                  } else { alert("æ— æ•ˆæ–‡ä»¶"); }
              } catch(err) { alert("æ–‡ä»¶é”™è¯¯"); }
          };
          reader.readAsText(file); input.value = "";
      };
    </script>
  </body>
</html>