<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>é©¬åŸæœŸæœ«å¤ä¹  - å†³æˆ˜ç‰ˆ V31.0</title>
    <style>
      :root {
        --primary: #4f46e5;
        --primary-light: #eef2ff;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --info: #0ea5e9;
        --text-main: #1e293b;
        --text-sub: #64748b;
        --bg-body: #f1f5f9;
        --bg-sidebar: #ffffff;
        --bg-card: #ffffff;
        --border-color: #e2e8f0;
        --sidebar-width: 280px;
        --safe-bottom: env(safe-area-inset-bottom, 20px);
        --content-font-size: 1.15rem;
      }

      body.dark-mode {
        --primary: #818cf8;
        --primary-light: #312e81;
        --success: #34d399;
        --warning: #fbbf24;
        --error: #f87171;
        --info: #38bdf8;
        --text-main: #f1f5f9;
        --text-sub: #94a3b8;
        --bg-body: #0f172a;
        --bg-sidebar: #1e293b;
        --bg-card: #1e293b;
        --border-color: #334155;
      }

      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      body { margin: 0; padding: 0; font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; transition: background 0.3s, color 0.3s; }

      /* === ä¾§è¾¹æ  === */
      .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s; flex-shrink: 0; }
      .sidebar-header { padding: 15px; background: var(--bg-sidebar); border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; }
      .app-brand { font-size: 1.2rem; font-weight: 900; color: var(--primary); text-align: center; display: flex; justify-content: center; gap: 8px; align-items: center; }

      .search-box { position: relative; width: 100%; }
      .search-input { width: 100%; padding: 8px 10px 8px 30px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); font-size: 0.85rem; }
      .search-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 0.9rem; opacity: 0.5; }

      .countdown-card { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; box-shadow: 0 4px 6px rgba(99, 102, 241, 0.25); }
      .countdown-num { font-size: 1.4rem; font-weight: 800; margin: 0 4px; text-decoration: underline; text-underline-offset: 3px; }

      .func-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
      .func-btn { border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; white-space: nowrap; background: var(--bg-card); color: var(--text-sub); }
      .func-btn:hover { background: var(--bg-body); }
      .func-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
      
      .btn-recite.active { background: var(--info); border-color: var(--info); color: white; }
      .btn-wrong.active { background: var(--error); border-color: var(--error); color: white; }
      .btn-fav.active { background: var(--warning); border-color: var(--warning); color: white; }
      
      /* æ–°å¢ï¼šæ–©æ€ï¼ˆç†Ÿç»ƒï¼‰ç»Ÿè®¡æ ·å¼ */
      .kill-stat { font-size: 0.75rem; color: #10b981; background: rgba(16, 185, 129, 0.1); padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

      .chapter-list { flex: 1; overflow-y: auto; padding: 8px; }
      .chapter-item { padding: 10px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: var(--text-sub); transition: 0.2s; border: 1px solid transparent; font-size: 0.85rem; }
      .chapter-item:hover { background: var(--bg-body); }
      .chapter-item.active { background: var(--primary-light); color: var(--primary); border-color: var(--primary); font-weight: 600; }
      .badge-pill { font-size: 0.75rem; padding: 1px 6px; border-radius: 4px; background: var(--border-color); color: var(--text-sub); }
      .chapter-item.active .badge-pill { background: var(--bg-card); color: var(--primary); }
      .chapter-item .badge-pill.completed { background: var(--success); color: white; }

      .sidebar-footer { padding: 12px; border-top: 1px solid var(--border-color); background: var(--bg-sidebar); display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
      .tool-btn { background: var(--bg-body); border: 1px solid var(--border-color); color: var(--text-sub); padding: 6px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; justify-content: center; }
      .tool-btn:hover { color: var(--primary); border-color: var(--primary); }

      /* === ä¸»å†…å®¹åŒº === */
      .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; background: var(--bg-body); position: relative; min-width: 0; }
      
      .exam-bar { background: #1e293b; color: white; padding: 10px 15px; display: none; justify-content: space-between; align-items: center; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
      .exam-bar.active { display: flex; }

      .top-nav { background: var(--bg-card); padding: 10px 15px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; gap: 10px; z-index: 20; border-bottom: 1px solid var(--border-color); }
      .nav-row { display: flex; align-items: center; justify-content: space-between; }
      .menu-toggle { font-size: 1.4rem; background: none; border: none; color: var(--text-sub); cursor: pointer; display: none; margin-right: 10px; }
      .nav-title { font-weight: 700; font-size: 1rem; color: var(--text-main); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 150px; }
      .jump-box { padding: 5px 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; color: var(--text-main); outline: none; background: var(--bg-body); max-width: 120px; }
      
      .jump-unfinished-btn { background: var(--success); color: white; border: none; padding: 5px 8px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2); }
      .jump-unfinished-btn:active { transform: scale(0.95); }
      /* èƒŒè¯µæ¨¡å¼ä¸‹çš„è·³è½¬æŒ‰é’®æ ·å¼ */
      .jump-unfinished-btn.recite-jump { background: var(--info); box-shadow: 0 2px 4px rgba(14, 165, 233, 0.2); }

      .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 2px; scrollbar-width: none; }
      .filter-chip { padding: 4px 10px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-sub); font-size: 0.8rem; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: 0.2s; }
      .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
      .filter-chip.active-wrong { background: var(--error); color: white; border-color: var(--error); }
      /* æ–°å¢ï¼šèƒŒè¯µæ¨¡å¼ä¸‹çš„è¿‡æ»¤æŒ‰é’® */
      .filter-chip.active-recite { background: var(--info); color: white; border-color: var(--info); }
      .filter-chip.active-kill { background: #10b981; color: white; border-color: #10b981; }

      .progress-container { height: 4px; background: var(--border-color); width: 100%; border-radius: 2px; overflow: hidden; position: relative; }
      .progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease; }
      /* èƒŒè¯µæ¨¡å¼è¿›åº¦æ¡é¢œè‰² */
      .progress-bar.recite-bar { background: var(--info); }

      .content-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; justify-content: center; padding-bottom: 80px; }
      
      /* === å¢å¼ºç‰ˆ Card æ ·å¼ === */
      .card { background: var(--bg-card); border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); padding: 20px; width: 100%; max-width: 800px; height: fit-content; margin-bottom: 20px; position: relative; border: 1px solid var(--border-color); transition: border-color 0.3s; }

      .card.recite-mode { border-left: 5px solid var(--info); overflow: visible; }
      .card.wrong-mode { border-left: 5px solid var(--error); }
      .card.fav-mode { border-left: 5px solid var(--warning); }
      .card.mock-mode { border-left: 5px solid #8b5cf6; }
      .card.search-mode { border-left: 5px solid #ec4899; }
      
      /* æ–°å¢ï¼šå·²æ–©ï¼ˆMasteredï¼‰çŠ¶æ€æ ·å¼ */
      .card.mastered-card { opacity: 0.7; border-style: dashed; }
      .mastered-badge { position: absolute; top: 10px; right: 50px; background: #10b981; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; transform: rotate(10deg); box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 2px solid white; z-index: 20; }

      .q-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
      .q-type { font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; font-weight: 700; background: var(--bg-body); color: var(--text-sub); border: 1px solid var(--border-color); }
      .q-type.single { color: #0284c7; border-color: #0284c7; background: #e0f2fe; }
      .q-type.multi { color: #d97706; border-color: #d97706; background: #fef3c7; }
      .dark-mode .q-type.single { background: rgba(2, 132, 199, 0.2); }
      .dark-mode .q-type.multi { background: rgba(217, 119, 6, 0.2); }
      
      .chapter-tag { font-size: 0.75rem; color: var(--text-sub); background: var(--bg-body); padding: 2px 8px; border-radius: 4px; margin-left: 8px; border: 1px solid var(--border-color); max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle; }

      .star-icon { font-size: 1.4rem; color: var(--border-color); cursor: pointer; margin-left: 10px; transition: transform 0.2s; }
      .star-icon.active { color: #f59e0b; transform: scale(1.2); }

      .q-content { font-size: var(--content-font-size); line-height: 1.6; color: var(--text-main); margin-bottom: 20px; white-space: pre-wrap; font-weight: 500; transition: font-size 0.2s; }
      
      /* èƒŒä¹¦æ¨¡å¼æ‚¬æµ®é¢˜å¹² */
      .card.recite-mode .q-content { position: sticky; top: -20px; z-index: 10; background: var(--bg-card); padding: 15px 0; border-bottom: 3px solid var(--primary-light); margin-bottom: 20px; margin-top: -10px; box-shadow: 0 4px 10px -4px rgba(0,0,0,0.1); }
      .dark-mode .card.recite-mode .q-content { border-bottom-color: #312e81; }

      .opts-container { display: flex; flex-direction: column; gap: 10px; }
      .opt-row { display: flex; padding: 14px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; background: var(--bg-card); transition: 0.1s; align-items: flex-start; }
      .opt-row:active { transform: scale(0.99); background: var(--bg-body); }
      
      /* èƒŒä¹¦æ¨¡å¼æ ·å¼ä¼˜åŒ– - å¼ºåŠ›é«˜äº®ç‰ˆ */
      .card.recite-mode .opts-container { pointer-events: none; gap: 14px; /* å¢åŠ é˜…è¯»é—´è· */ } 
      .card.recite-mode .opt-row { border-color: var(--border-color); background: var(--bg-card); }
      
      .card.recite-mode .opt-row.correct { background: #f0fdf4; border: 2px solid #22c55e; transform: scale(1.02); box-shadow: 0 8px 20px rgba(34, 197, 94, 0.15); margin: 5px 0; position: relative; z-index: 5; }
      .card.recite-mode .opt-row.correct .opt-icon { background: #22c55e; border-color: #22c55e; color: white; font-weight: 900; }
      .card.recite-mode .opt-row.correct .opt-text { font-weight: 700; color: #15803d; font-size: 1.05em; }
      /* ç»™æ­£ç¡®ç­”æ¡ˆåŠ ä¸ªé’©å­ï¼Œæ›´ç›´è§‚ */
      .card.recite-mode .opt-row.correct .opt-text::before { content: "âœ… "; }
      
      .dark-mode .card.recite-mode .opt-row.correct { background: rgba(34, 197, 94, 0.15); border-color: #22c55e; }
      .dark-mode .card.recite-mode .opt-row.correct .opt-text { color: #86efac; }

      .opt-icon { width: 24px; height: 24px; margin-right: 10px; border: 1px solid var(--text-sub); display: flex; align-items: center; justify-content: center; color: var(--text-sub); flex-shrink: 0; font-size: 0.85rem; font-weight: bold; background: transparent; transition: all 0.2s; }
      .opt-row.single-mode .opt-icon { border-radius: 50%; }
      .opt-row.multi-mode .opt-icon { border-radius: 4px; }

      .opt-row.selected { border-color: var(--primary); background: var(--primary-light); }
      .opt-row.selected .opt-icon { background: var(--primary); border-color: var(--primary); color: white; }
      .dark-mode .opt-row.selected { background: rgba(99, 102, 241, 0.2); }

      .opt-row.correct { border-color: var(--success); background: #ecfdf5; }
      .opt-row.correct .opt-icon { background: var(--success); border-color: var(--success); color: white; }
      
      .opt-row.wrong { border-color: var(--error); background: #fef2f2; }
      .opt-row.wrong .opt-icon { background: var(--error); border-color: var(--error); color: white; }
      .dark-mode .opt-row.wrong { background: rgba(239, 68, 68, 0.2); }
      
      .opt-row.missed { border-color: var(--warning); border-style: dashed; }
      .opt-row.missed .opt-icon { background: var(--warning); border-color: var(--warning); color: white; }

      .opt-text { flex: 1; font-size: calc(var(--content-font-size) - 0.1rem); line-height: 1.5; color: var(--text-main); }

      .answer-section { margin-top: 20px; padding: 15px; background: var(--bg-body); border-radius: 8px; display: none; border: 1px solid var(--border-color); }
      .answer-section.show { display: block; animation: slideDown 0.3s; }
      
      .action-bar { background: var(--bg-card); border-top: 1px solid var(--border-color); padding: 10px 15px; padding-bottom: max(10px, var(--safe-bottom)); display: flex; gap: 12px; align-items: center; position: fixed; bottom: 0; width: calc(100% - var(--sidebar-width)); z-index: 40; }
      .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
      .btn:active { transform: scale(0.98); }
      .btn-secondary { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-color); }
      .btn-primary { background: var(--primary); color: white; flex: 2; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }
      .btn-recite { background: var(--info); color: white; flex: 2; }
      .btn-kill { background: #10b981; color: white; flex: 1; font-size: 0.85rem; }

      /* Toast é€šçŸ¥ */
      .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; z-index: 200; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
      .toast.show { opacity: 1; }

      /* Score Modal */
      .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; text-align: center; border: 1px solid var(--border-color); color: var(--text-main); }
      .modal h2 { margin-top: 0; color: var(--primary); }
      .score-big { font-size: 3rem; font-weight: 800; color: var(--primary); margin: 10px 0; }
      .score-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; font-size: 0.9rem; }
      .wrong-list { max-height: 150px; overflow-y: auto; text-align: left; background: var(--bg-body); padding: 10px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
      .wrong-tag { background: #fef2f2; color: var(--error); border: 1px solid #fca5a5; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
      
      .overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 45; display: none; }
      #fileInput { display: none; }

      @media (max-width: 768px) {
        .sidebar { position: fixed; left: -100%; height: 100%; width: 85%; box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2); }
        .sidebar.open { left: 0; }
        .menu-toggle { display: block; }
        .overlay.active { display: block; }
        .action-bar { width: 100%; }
        .content-area { padding: 15px; padding-bottom: 80px; }
      }
      @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <div class="toast" id="toast">æç¤ºä¿¡æ¯</div>
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="app-brand">
            <span>âš¡ï¸ é©¬åŸå†³æˆ˜ç‰ˆ</span>
            <span style="font-size:0.7rem; background:var(--warning); color:white; padding:2px 4px; border-radius:4px;">V31.0</span>
        </div>
        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" class="search-input" placeholder="æœç´¢é¢˜ç›®..." oninput="handleSearch(this.value)">
        </div>
        <div class="countdown-card" onclick="editExamDate()" title="ç‚¹å‡»ä¿®æ”¹æ—¥æœŸ">
            <div style="font-size:0.75rem; opacity:0.9">è·ç¦»æœŸæœ«è€ƒè¯•è¿˜æœ‰</div>
            <div style="margin:2px 0">
                <span class="countdown-num" id="daysLeft">--</span> å¤©
            </div>
            <div style="font-size:0.7rem; opacity:0.8" id="examDateStr">åŠ æ²¹ï¼</div>
        </div>
        <div class="func-grid">
            <button class="func-btn active" onclick="switchModule('main')" id="btn-main">ğŸ“– ç« èŠ‚ç»ƒä¹ </button>
            <button class="func-btn btn-recite" onclick="toggleReciteMode()" id="btn-recite">ğŸ“— èƒŒè¯µæ¨¡å¼</button>
        </div>
        <div class="func-grid">
            <button class="func-btn btn-wrong" onclick="switchModule('wrong_book')" id="btn-wrong">âŒ é”™é¢˜æœ¬ <span id="wrongCount"></span></button>
            <button class="func-btn btn-fav" onclick="switchModule('favorites')" id="btn-fav">â­ æ”¶è—å¤¹ <span id="favCount"></span></button>
        </div>
        <div class="func-grid">
            <button class="func-btn btn-mock" onclick="startMockExam()" id="btn-mock">ğŸ“ æ¨¡æ‹Ÿè€ƒ</button>
            <button class="func-btn" onclick="switchModule('random_drill')" id="btn-random">ğŸ”€ ä¹±åºåˆ·</button>
        </div>
        <div style="padding: 5px 0; font-size: 0.8rem; color: var(--text-sub); display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ—¡ï¸ å·²æ–©é¢˜æ•°:</span>
            <span style="font-weight: bold; color: #10b981;" id="killCount">0</span>
        </div>
      </div>
      <div class="chapter-list" id="chapterList"></div>
      <div class="sidebar-footer">
          <button class="tool-btn" onclick="adjustFontSize(-0.1)"><span>A-</span><span>å­—å·</span></button>
          <button class="tool-btn" onclick="adjustFontSize(0.1)"><span>A+</span><span>å­—å·</span></button>
          <button class="tool-btn" onclick="toggleDarkMode()"><span>ğŸŒ™</span><span>å¤œé—´</span></button>
          <button class="tool-btn" onclick="exportData()"><span>ğŸ’¾</span><span>å¤‡ä»½</span></button>
      </div>
      <div style="padding:5px; text-align:center; background:var(--bg-sidebar); border-top:1px solid var(--border-color); display:flex; gap:5px;">
          <button class="tool-btn" style="flex:1; color:var(--error); border:none; background:transparent;" onclick="resetWrongBook()">ğŸ”¥ é‡ç½®é”™é¢˜</button>
          <button class="tool-btn" style="flex:1; color:var(--warning); border:none; background:transparent;" onclick="resetCurrentChapter()">â†» é‡ç½®æœ¬ç« </button>
      </div>
    </div>
    <div class="overlay" id="overlay" onclick="closeAll()"></div>
    <input type="file" id="fileInput" accept=".json" onchange="handleFileImport(this)">

    <!-- æˆç»©å• Modal -->
    <div class="modal" id="scoreModal">
        <h2>ğŸ‰ è€ƒè¯•ç»“æŸ</h2>
        <div class="score-big" id="modalScore">0</div>
        <div class="score-grid">
            <div>âœ… æ­£ç¡®: <span id="modalCorrect">0</span></div>
            <div>âŒ é”™è¯¯: <span id="modalWrong">0</span></div>
        </div>
        <div style="text-align:left; font-size:0.85rem; margin-bottom:5px; color:var(--text-sub)">ç‚¹å‡»é¢˜å·æŸ¥çœ‹é”™é¢˜ï¼š</div>
        <div class="wrong-list" id="modalWrongList"></div>
        <button class="btn btn-primary" onclick="closeModal()">å…³é—­å¹¶å¤ä¹ </button>
    </div>

    <div class="main-content">
      <div class="exam-bar" id="examBar">
          <div>â³ <span id="examTimer">45:00</span></div>
          <button onclick="submitExam()" style="background:#ef4444; color:white; border:none; padding:5px 12px; border-radius:4px; cursor:pointer; font-weight:bold;">äº¤å·</button>
      </div>
      <div class="top-nav" id="normalNav">
        <div class="nav-row">
          <div style="display: flex; align-items: center; overflow: hidden; gap:10px;">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            <div class="nav-title" id="headerTitle">åŠ è½½ä¸­...</div>
            <button class="jump-unfinished-btn" onclick="jumpToUnfinished()" title="ç»§ç»­åšé¢˜/èƒŒè¯µ" id="jumpBtn">â­ï¸ ç»§ç»­</button>
          </div>
          <div style="display:flex; align-items:center; gap:8px">
              <div id="reciteBadge" style="display:none; background:var(--info); color:white; font-size:0.75rem; padding:2px 6px; border-radius:4px;">èƒŒè¯µæ¨¡å¼</div>
              <select class="jump-box" id="qJumper" onchange="jumpTo(this.value)" disabled><option>0/0</option></select>
          </div>
        </div>
        <div class="filter-scroll" id="filterBar">
          <button class="filter-chip active" onclick="setFilter('all')">â™¾ï¸ å…¨éƒ¨</button>
          <button class="filter-chip" onclick="setFilter('wrong')">âŒ åªçœ‹é”™é¢˜</button>
          <button class="filter-chip" onclick="setFilter('å•é€‰')">ğŸ”´ å•é€‰é¢˜</button>
          <button class="filter-chip" onclick="setFilter('å¤šé€‰')">ğŸ”µ å¤šé€‰é¢˜</button>
          <!-- ä»…åœ¨èƒŒè¯µæ¨¡å¼ä¸‹æ˜¾ç¤º -->
          <button class="filter-chip" id="killFilter" onclick="setFilter('kill')" style="display:none">ğŸ—¡ï¸ å·²æ–©é¢˜</button>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
      </div>
      <div class="content-area" id="qContainer">
        <div style="text-align: center; margin-top: 100px; color: var(--text-sub)">
            <div style="font-size:2rem; margin-bottom:10px">â³</div>
            <p>ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</p>
        </div>
      </div>
      <div class="action-bar" id="actionBar">
        <button class="btn btn-secondary" onclick="move(-1)">â¬…ï¸ ä¸Šä¸€é¢˜</button>
        <button class="btn btn-kill" id="killBtn" onclick="toggleKill()" style="display:none">ğŸ—¡ï¸ æ–©é¢˜</button>
        <button class="btn btn-primary" id="mainBtn" onclick="handleMainAction()">âœ… æäº¤ç­”æ¡ˆ</button>
        <button class="btn btn-secondary" onclick="move(1)">ä¸‹ä¸€é¢˜ â¡ï¸</button>
      </div>
    </div>

    <script>
      const modules = {
        main: { name: "ç« èŠ‚ç»ƒä¹ ", data: [], prefix: "ma_" },
        wrong_book: { name: "é”™é¢˜é›†", data: [], prefix: "wb_" },
        random_drill: { name: "ä¹±åºåˆ·é¢˜", data: [], prefix: "rd_" },
        favorites: { name: "æ”¶è—å¤¹", data: [], prefix: "fav_" },
        mock: { name: "æ¨¡æ‹Ÿè€ƒè¯•", data: [], prefix: "mock_" },
        search: { name: "æœç´¢ç»“æœ", data: [], prefix: "search_" }
      };

      let curMod = "main";
      let curChapter = "";
      let rawList = []; 
      let filteredList = [];
      let curIndex = 0; 
      let filterType = "all";
      let userSel = new Set(); 
      let wrongSet = new Set();
      let favSet = new Set();
      let killSet = new Set(); // æ–©æ€é¢˜é›†åˆ
      let reciteProgress = {}; // èƒŒè¯µè¿›åº¦è®°å½•
      let isReciteMode = false;
      let isExamMode = false;
      let examInterval = null;
      let examSeconds = 0;
      let currentFontSize = 1.15;

      window.onload = async function() {
        initDarkMode();
        initCountdown();
        const savedWrongs = localStorage.getItem("wrong_questions");
        if (savedWrongs) wrongSet = new Set(JSON.parse(savedWrongs));
        const savedFavs = localStorage.getItem("favorites");
        if (savedFavs) favSet = new Set(JSON.parse(savedFavs));
        
        // åŠ è½½æ–©æ€è®°å½•
        const savedKills = localStorage.getItem("kill_questions");
        if (savedKills) killSet = new Set(JSON.parse(savedKills));
        
        // åŠ è½½èƒŒè¯µè¿›åº¦
        const savedRecite = localStorage.getItem("recite_progress");
        if (savedRecite) reciteProgress = JSON.parse(savedRecite);

        try {
            const response = await fetch('./æå–ç»“æœ_å¸¦ç­”æ¡ˆ.md');
            if(response.ok) {
                const text = await response.text();
                modules.main.data = parseMarkdown(text);
                syncGlobalWrongStatus(); 
                switchModule('main');
                const lastChap = localStorage.getItem("last_chapter");
                if (lastChap) loadChapter(lastChap);
            } else {
                const cached = localStorage.getItem("cached_questions");
                if(cached) {
                    modules.main.data = JSON.parse(cached);
                    switchModule('main');
                } else {
                    throw new Error("æ— æ•°æ®");
                }
            }
        } catch(e) {
             document.getElementById("qContainer").innerHTML = `<div style="text-align:center; margin-top:50px;"><h3>âš ï¸ é¢˜åº“åŠ è½½å¤±è´¥</h3><p style="color:var(--text-sub)">è¯·ç¡®è®¤ç›®å½•ä¸‹å­˜åœ¨ <code>æå–ç»“æœ_å¸¦ç­”æ¡ˆ.md</code></p></div>`;
        }
        updateCounts();
        document.addEventListener('keydown', (e) => {
            if(e.key === 'ArrowLeft') move(-1);
            if(e.key === 'ArrowRight') move(1);
            if(e.key === 'Enter' && !isReciteMode) handleMainAction();
        });
      };

      // ä¿®å¤ï¼šä¼˜åŒ–æ­£åˆ™ä»¥æ”¯æŒè·¨è¡Œé€‰é¡¹æ–‡æœ¬
      function parseMarkdown(text) {
        const lines = text.split(/\r?\n/);
        const questions = [];
        let currentChapter = "é»˜è®¤ç« èŠ‚";
        let currentType = "å•é€‰é¢˜"; 
        let tempQ = null;
        
        const saveQuestion = () => {
           if (tempQ) {
               const bracketRegex = /([ï¼ˆ(])\s*([A-Ea-e]+)\s*([)ï¼‰])/;
               const inlineAns = tempQ.content.match(bracketRegex);
               if (inlineAns) {
                   if (!tempQ.answer) tempQ.answer = inlineAns[2].toUpperCase().trim();
                   tempQ.content = tempQ.content.replace(bracketRegex, "ï¼ˆ ï¼‰");
               }
               
               if (tempQ.answer && tempQ.answer.length > 1) {
                   tempQ.type = "å¤šé€‰é¢˜";
               } else if (!tempQ.type) {
                   tempQ.type = currentType;
               }
               
               const str = tempQ.chapter + tempQ.content.substring(0, 15);
               let hash = 0;
               for (let i = 0; i < str.length; i++) hash = (hash << 5) - hash + str.charCodeAt(i);
               tempQ._uid = `q_${Math.abs(hash)}`;
               questions.push(tempQ);
           }
        };

        for (let line of lines) {
            line = line.trim();
            if (!line) continue;
            
            if (line.includes("å•é¡¹é€‰æ‹©") || line.includes("å•é€‰")) { currentType = "å•é€‰é¢˜"; }
            if (line.includes("å¤šé¡¹é€‰æ‹©") || line.includes("å¤šé€‰") || line.includes("ä¸å®šé¡¹")) { currentType = "å¤šé€‰é¢˜"; }

            if (line.match(/^##\s+/)) {
                saveQuestion();
                currentChapter = line.replace(/^##\s+/, '').trim();
                tempQ = null;
                continue;
            }
            
            // è¯†åˆ«é¢˜ç›®å¼€å§‹
            const qMatch = line.match(/^(\d+)[\.ï¼ã€\s]\s*(.+)/);
            const isOptionStart = /^[A-Ea-e][\.ï¼ã€\s]/.test(line);
            
            if (qMatch && !isOptionStart) {
                saveQuestion();
                tempQ = { 
                    chapter: currentChapter, 
                    type: currentType, 
                    content: qMatch[2].trim(), 
                    options: [], 
                    answer: "", 
                    userSel: new Set(), 
                    isSubmitted: false 
                };
                continue;
            }
            
            // è¯†åˆ«é€‰é¡¹ - é‡ç‚¹ä¿®æ”¹å¤„
            if ((isOptionStart || line.match(/^[A-Ea-e]\s+/)) && tempQ) {
                const optRegex = /([A-Ea-e])[\.ï¼ã€\s]\s*([\s\S]*?)(?=\s+[A-Ea-e][\.ï¼ã€\s]|$)/g;
                let match;
                let found = false;
                while ((match = optRegex.exec(line)) !== null) {
                    found = true;
                    tempQ.options.push({ label: match[1].toUpperCase(), text: match[2].trim() });
                }
                if (!found) {
                     const simpleMatch = line.match(/^([A-Ea-e])[\.ï¼ã€\s]\s*([\s\S]+)/);
                     if(simpleMatch) {
                         tempQ.options.push({ label: simpleMatch[1].toUpperCase(), text: simpleMatch[2].trim() });
                     } else if (tempQ.options.length > 0) {
                         tempQ.options[tempQ.options.length-1].text += "\n" + line;
                     }
                }
                continue;
            }
            
            const ansMatch = line.match(/ã€ç­”æ¡ˆã€‘\s*([A-Za-z\s,ï¼Œ]+)/);
            if (ansMatch && tempQ) { 
                tempQ.answer = ansMatch[1].toUpperCase().replace(/[^A-Z]/g, ''); 
            }
        }
        saveQuestion();
        return questions;
      }

      function getQuestionType(q) {
          if (q.type && (q.type.includes("å¤š") || q.type.includes("ä¸å®šé¡¹"))) return 'multi';
          if (q.answer && q.answer.length > 1) return 'multi';
          return 'single';
      }

      function renderQ() {
        if (!filteredList.length) {
            document.getElementById("qContainer").innerHTML = `<div style="text-align:center;margin-top:50px;color:var(--text-sub)">æ— ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®</div>`;
            return;
        }
        const q = filteredList[curIndex];
        userSel = new Set(q.userSel);
        
        document.getElementById("headerTitle").innerText = isExamMode ? "æ¨¡æ‹Ÿè€ƒè¯•ä¸­..." : curChapter;
        document.getElementById("qJumper").value = curIndex;
        document.getElementById("reciteBadge").style.display = isReciteMode ? "block" : "none";
        document.getElementById("killFilter").style.display = isReciteMode ? "flex" : "none";
        
        // è¿›åº¦æ¡ä¸æ ‡é¢˜é€»è¾‘
        const progress = Math.round(((curIndex + 1) / filteredList.length) * 100);
        const pBar = document.getElementById('progressBar');
        pBar.style.width = `${progress}%`;
        
        const jumpBtn = document.getElementById("jumpBtn");
        // å¦‚æœæ˜¯èƒŒè¯µæ¨¡å¼ï¼Œæ˜¾ç¤ºâ€œæ¢å¤è¿›åº¦â€æŒ‰é’®
        if (isReciteMode) {
            pBar.classList.add('recite-bar');
            jumpBtn.style.display = 'flex'; // æ˜¾ç¤ºæŒ‰é’®
            jumpBtn.innerText = "ğŸ“ æ¢å¤è¿›åº¦";
            jumpBtn.title = "è·³è½¬åˆ°ä¸Šæ¬¡èƒŒè¯µçš„ä½ç½®";
            jumpBtn.classList.add('recite-jump');
        } else {
            pBar.classList.remove('recite-bar');
            jumpBtn.style.display = 'flex';
            jumpBtn.innerText = "â­ï¸ ç»§ç»­";
            jumpBtn.title = "è·³è½¬åˆ°ç¬¬ä¸€é“æ²¡åšçš„é¢˜";
            jumpBtn.classList.remove('recite-jump');
        }

        const container = document.getElementById("qContainer");
        let cardClass = "card";
        if (isReciteMode) cardClass += " recite-mode";
        else if (curMod === 'wrong_book') cardClass += " wrong-mode";
        else if (curMod === 'favorites') cardClass += " fav-mode";
        else if (isExamMode) cardClass += " mock-mode";
        else if (curMod === 'search') cardClass += " search-mode";
        
        const isKilled = killSet.has(q._uid);
        if (isKilled) cardClass += " mastered-card";

        // æŒ‰é’®é€»è¾‘
        const mBtn = document.getElementById("mainBtn");
        const kBtn = document.getElementById("killBtn");
        
        if (isReciteMode) {
            mBtn.innerText = "ä¸‹ä¸€é¢˜ â¡ï¸"; mBtn.className = "btn btn-recite"; mBtn.onclick = () => move(1);
            kBtn.style.display = "flex";
            kBtn.innerText = isKilled ? "â†©ï¸ æ¢å¤" : "ğŸ—¡ï¸ æ–©é¢˜(å·²ç†Ÿ)";
            kBtn.style.background = isKilled ? "#64748b" : "#10b981";
        } else if (q.isSubmitted) {
            mBtn.innerText = curIndex < filteredList.length - 1 ? "ä¸‹ä¸€é¢˜ â¡ï¸" : "æœ¬ç« å®Œæˆ";
            mBtn.className = "btn btn-primary"; mBtn.onclick = handleMainAction;
            kBtn.style.display = "none";
        } else {
            mBtn.innerText = "âœ… æäº¤ç­”æ¡ˆ"; mBtn.className = "btn btn-primary"; mBtn.onclick = handleMainAction;
            kBtn.style.display = "none";
        }
        if (isExamMode) {
            mBtn.innerText = curIndex < filteredList.length - 1 ? "ä¸‹ä¸€é¢˜ â¡ï¸" : "å®Œæˆ";
            mBtn.className = "btn btn-secondary"; mBtn.onclick = () => move(1);
        }

        const type = getQuestionType(q);
        const typeLabel = type === 'multi' ? "å¤šé€‰é¢˜" : "å•é€‰é¢˜";
        const typeClass = type === 'multi' ? "q-type multi" : "q-type single";
        const isFav = favSet.has(q._uid);
        const starHtml = `<span class="star-icon ${isFav?'active':''}" onclick="toggleFav('${q._uid}')">â­</span>`;
        const chapterHtml = `<span class="chapter-tag" title="${q.chapter}">${q.chapter}</span>`;
        const masteredHtml = isKilled ? `<div class="mastered-badge">å·²æ–©æ€</div>` : '';

        let optsHtml = "";
        if (q.options && q.options.length > 0) {
            const correctSet = new Set((q.answer || "").toUpperCase().split(""));
            optsHtml = `<div class="opts-container">
              ${q.options.map(opt => {
                  let cls = `opt-row ${type === 'multi' ? 'multi-mode' : 'single-mode'}`;
                  
                  if (isReciteMode) {
                      // èƒŒä¹¦æ¨¡å¼ï¼šä»…é«˜äº®æ­£ç¡®
                      if (correctSet.has(opt.label)) cls += " correct";
                  } 
                  else if (isExamMode) {
                      if (userSel.has(opt.label)) cls += " selected";
                  }
                  else if (q.isSubmitted) {
                      if (correctSet.has(opt.label)) {
                          cls += " correct";
                          if (!userSel.has(opt.label)) cls += " missed";
                      } else if (userSel.has(opt.label)) {
                          cls += " wrong";
                      }
                  } 
                  else {
                      if (userSel.has(opt.label)) cls += " selected";
                  }

                  return `
                 <div class="${cls}" onclick="handleOpt('${opt.label}')">
                   <div class="opt-icon">${opt.label}</div>
                   <div class="opt-text">${opt.text}</div>
                 </div>`;
                }).join("")}
            </div>`;
        } else {
            optsHtml = `<div style="padding:10px; color:var(--text-sub)">(æš‚æ— é€‰é¡¹)</div>`;
        }

        const showAns = isReciteMode || (!isExamMode && q.isSubmitted);
        
        // èƒŒä¹¦æ¨¡å¼ä¸‹çš„é¢å¤–ä¿¡æ¯
        let reciteInfo = "";
        if(isReciteMode) {
             reciteInfo = `<div style="margin-top:10px; font-size:0.8rem; color:var(--info); text-align:right;">å½“å‰èƒŒè¯µè¿›åº¦: ${curIndex + 1} / ${filteredList.length}</div>`;
        }

        container.innerHTML = `
          <div class="${cardClass}">
             ${masteredHtml}
             <div class="q-header">
                <div style="display:flex; align-items:center;">
                    <span class="${typeClass}">${typeLabel}</span>
                    ${chapterHtml}
                    ${starHtml}
                </div>
                <span style="font-size:0.8rem; color:var(--text-sub)">${curIndex + 1} / ${filteredList.length}</span>
             </div>
             <div class="q-content">${q.content}</div>
             ${optsHtml}
             <div class="answer-section ${showAns ? "show" : ""}" id="ansPanel">
                <div style="margin-bottom:10px;">
                   <span style="font-weight:bold; color:var(--text-main)">å‚è€ƒç­”æ¡ˆï¼š</span>
                   <span style="color:var(--primary); font-weight:bold; font-size:1.2rem">${q.answer || "ç•¥"}</span>
                </div>
                ${reciteInfo}
             </div>
          </div>
        `;
      }

      window.handleOpt = function (label) {
        if (isReciteMode) return; // èƒŒä¹¦æ¨¡å¼ç¦æ­¢ç‚¹å‡»
        const q = filteredList[curIndex];
        if (!isExamMode && q.isSubmitted) return;

        const type = getQuestionType(q);
        if (type === 'multi') {
          if (userSel.has(label)) userSel.delete(label); else userSel.add(label);
        } else {
          userSel.clear(); userSel.add(label);
        }
        q.userSel = new Set(userSel);
        renderQ();
      };

      window.handleMainAction = function () {
        if(isExamMode) { move(1); return; }
        const q = filteredList[curIndex];
        if (q.isSubmitted) {
          move(1);
        } else {
          q.isSubmitted = true;
          const status = checkStatus(q);
          if (status !== 'correct') {
              if (!wrongSet.has(q._uid)) {
                  wrongSet.add(q._uid);
                  localStorage.setItem("wrong_questions", JSON.stringify(Array.from(wrongSet)));
                  updateCounts();
              }
          }
          if(curMod === 'main') saveProgress();
          renderQ();
          updateJumperOption(curIndex, status);
        }
      };
      
      // æ–©é¢˜é€»è¾‘
      window.toggleKill = function() {
          const q = filteredList[curIndex];
          if(killSet.has(q._uid)) {
              killSet.delete(q._uid);
              showToast("é¢˜ç›®å·²æ¢å¤ï¼Œä¸‹æ¬¡ä¼šå†æ¬¡é‡è§");
          } else {
              killSet.add(q._uid);
              showToast("ğŸ—¡ï¸ æ–©æ€æˆåŠŸï¼ä¸‹æ¬¡èƒŒè¯µå°†è·³è¿‡æ­¤é¢˜");
          }
          localStorage.setItem("kill_questions", JSON.stringify(Array.from(killSet)));
          updateCounts();
          renderQ(); // åˆ·æ–°æ˜¾ç¤ºçŠ¶æ€
      };
      
      function showToast(msg) {
          const t = document.getElementById('toast');
          t.innerText = msg;
          t.classList.add('show');
          setTimeout(() => t.classList.remove('show'), 2000);
      }

      window.handleSearch = function(keyword) {
          if(!keyword) return;
          keyword = keyword.trim().toLowerCase();
          if(keyword.length < 1) return;
          if(isExamMode) { 
              if(!confirm("æœç´¢å°†é€€å‡ºè€ƒè¯•æ¨¡å¼ï¼Œç»§ç»­ï¼Ÿ")) { document.querySelector('.search-input').value = ""; return; }
              submitExam();
          }
          curMod = 'search';
          document.querySelectorAll('.func-btn').forEach(b => b.classList.remove('active'));
          rawList = modules.main.data.filter(q => q.content.toLowerCase().includes(keyword)).map(q => ({...q, userSel: new Set(), isSubmitted: false}));
          curChapter = `æœç´¢: "${keyword}"`;
          if(rawList.length === 0) {
              document.getElementById("qContainer").innerHTML = `<div style="text-align:center;margin-top:50px;color:var(--text-sub)">æœªæ‰¾åˆ°ç›¸å…³é¢˜ç›®</div>`;
              document.getElementById("headerTitle").innerText = curChapter;
              document.getElementById("qJumper").disabled = true;
          } else {
              setFilter('all');
          }
          if(window.innerWidth <= 768) closeAll();
      };

      window.jumpToUnfinished = function() {
          // ä¿®æ”¹é€»è¾‘ï¼šæ ¹æ®æ¨¡å¼ä¸åŒï¼Œè·³è½¬é€»è¾‘ä¸åŒ
          if (isReciteMode) {
               const lastIdx = reciteProgress[curChapter] || 0;
               if (curIndex === lastIdx) {
                   showToast("å½“å‰å·²åœ¨ä¸Šæ¬¡èƒŒè¯µä½ç½®");
               } else {
                   jumpTo(lastIdx);
                   showToast(`å·²å›åˆ°ä¸Šæ¬¡è¿›åº¦: ç¬¬ ${lastIdx + 1} é¢˜`);
               }
          } else {
              const idx = filteredList.findIndex(q => !q.isSubmitted);
              if(idx !== -1) { jumpTo(idx); } else { alert("æœ¬é¡µé¢˜ç›®å·²å…¨éƒ¨å®Œæˆï¼"); }
          }
      };

      window.adjustFontSize = function(delta) {
          currentFontSize += delta;
          if(currentFontSize < 0.8) currentFontSize = 0.8;
          if(currentFontSize > 2.0) currentFontSize = 2.0;
          document.documentElement.style.setProperty('--content-font-size', currentFontSize + 'rem');
      };

      function initDarkMode() { if(localStorage.getItem("dark_mode") === "true") document.body.classList.add("dark-mode"); }
      window.toggleDarkMode = function() { document.body.classList.toggle("dark-mode"); localStorage.setItem("dark_mode", document.body.classList.contains("dark-mode")); };

      window.toggleReciteMode = function() {
          if (isExamMode) return alert("è€ƒè¯•ä¸­æ— æ³•åˆ‡æ¢æ¨¡å¼");
          isReciteMode = !isReciteMode;
          const btn = document.getElementById("btn-recite");
          
          if(isReciteMode) {
              btn.classList.add("active");
              // è¿›å…¥èƒŒä¹¦æ¨¡å¼ï¼Œå°è¯•è¯»å–è¿›åº¦
              if(curMod === 'main' && reciteProgress[curChapter] !== undefined) {
                  // å¦‚æœæœ‰è¿›åº¦ä¸”ä¸æ˜¯ç¬¬ä¸€é¢˜ï¼Œè¯¢é—®æ˜¯å¦è·³è½¬
                  if(reciteProgress[curChapter] > 0 && reciteProgress[curChapter] < filteredList.length) {
                      const rIndex = reciteProgress[curChapter];
                      // è‡ªåŠ¨è·³è½¬ï¼Œä½“éªŒæ›´æµç•…ï¼Œç»™ä¸ªæç¤ºå³å¯
                      curIndex = rIndex;
                      showToast(`å·²å®šä½åˆ°ä¸Šæ¬¡èƒŒè¯µä½ç½®: ç¬¬ ${rIndex+1} é¢˜`);
                  }
              }
              // å¦‚æœå½“å‰åˆ—è¡¨é‡Œæœ‰å¾ˆå¤šå·²æ–©é¢˜ï¼Œæç¤ºç”¨æˆ·å¯ä»¥è¿‡æ»¤
              const killedInList = filteredList.filter(q => killSet.has(q._uid)).length;
              if(killedInList > 0 && filterType !== 'all') {
                  // do nothing
              } else if (killedInList > 0) {
                  // å¯ä»¥åœ¨è¿™é‡Œæç¤ºè¿‡æ»¤ï¼Œç›®å‰æš‚ä¸å¼ºåˆ¶
              }
          } else {
              btn.classList.remove("active");
          }
          renderQ();
          if(window.innerWidth <= 768) closeAll();
      };

      window.toggleFav = function(uid) {
          if (favSet.has(uid)) favSet.delete(uid); else favSet.add(uid);
          localStorage.setItem("favorites", JSON.stringify(Array.from(favSet)));
          updateCounts();
          renderQ();
      };

      window.startMockExam = function() {
          if(!confirm("å¼€å§‹45åˆ†é’Ÿå…¨çœŸæ¨¡æ‹Ÿè€ƒï¼Ÿ\n(30å•é€‰+10å¤šé€‰)")) return;
          isExamMode = true; isReciteMode = false; curMod = "mock";
          document.getElementById("btn-recite").classList.remove("active");
          const singles = modules.main.data.filter(q => getQuestionType(q) === 'single');
          const multis = modules.main.data.filter(q => getQuestionType(q) === 'multi');
          singles.sort(() => Math.random() - 0.5); multis.sort(() => Math.random() - 0.5);
          rawList = [...singles.slice(0, 30), ...multis.slice(0, 10)].map(q => ({...q, userSel: new Set(), isSubmitted: false}));
          filteredList = rawList; curIndex = 0;
          document.getElementById("normalNav").style.display = "none";
          document.getElementById("examBar").classList.add("active");
          document.getElementById("actionBar").style.display = "flex";
          closeAll(); renderQ();
          examSeconds = 45 * 60;
          examInterval = setInterval(() => {
              examSeconds--;
              const m = Math.floor(examSeconds / 60).toString().padStart(2,'0');
              const s = (examSeconds % 60).toString().padStart(2,'0');
              document.getElementById("examTimer").innerText = `${m}:${s}`;
              if(examSeconds <= 0) submitExam();
          }, 1000);
      };

      window.submitExam = function() {
          clearInterval(examInterval); isExamMode = false;
          document.getElementById("normalNav").style.display = "flex";
          document.getElementById("examBar").classList.remove("active");
          let score = 0, correct = 0, wrong = 0;
          let wrongIndices = [];
          rawList.forEach((q, idx) => {
              q.isSubmitted = true;
              if(checkStatus(q) === 'correct') {
                  score += (getQuestionType(q)==='single' ? 1 : 2);
                  correct++;
              } else {
                  wrong++;
                  wrongIndices.push(idx);
              }
          });
          
          document.getElementById('modalScore').innerText = score;
          document.getElementById('modalCorrect').innerText = correct;
          document.getElementById('modalWrong').innerText = wrong;
          
          const list = document.getElementById('modalWrongList');
          list.innerHTML = "";
          wrongIndices.forEach(idx => {
              const span = document.createElement('span');
              span.className = 'wrong-tag';
              span.innerText = idx + 1;
              span.onclick = () => { closeModal(); jumpTo(idx); };
              list.appendChild(span);
          });
          
          document.getElementById('scoreModal').style.display = 'block';
          document.getElementById('overlay').style.display = 'block';
          renderQ();
      };
      
      window.closeModal = function() {
          document.getElementById('scoreModal').style.display = 'none';
          document.getElementById('overlay').style.display = 'none';
      }

      function syncGlobalWrongStatus() {
          let hasUpdates = false;
          const chapMap = new Map();
          modules.main.data.forEach(q => { if(!chapMap.has(q.chapter)) chapMap.set(q.chapter, []); chapMap.get(q.chapter).push(q); });
          for (const [chapName, questions] of chapMap) {
             const key = "ma_" + chapName;
             const savedJson = localStorage.getItem(key);
             if(!savedJson) continue;
             try {
                 const savedState = JSON.parse(savedJson);
                 savedState.forEach((state, i) => {
                     if (state && state.done && questions[i]) {
                         const q = questions[i];
                         const tempQ = { ...q, userSel: new Set(state.sel) };
                         if(checkStatus(tempQ) !== 'correct') {
                             if(!wrongSet.has(q._uid)) { wrongSet.add(q._uid); hasUpdates = true; }
                         }
                     }
                 });
             } catch(e) {}
          }
          if(hasUpdates) { localStorage.setItem("wrong_questions", JSON.stringify(Array.from(wrongSet))); updateCounts(); }
      }

      function checkStatus(q) {
          const correctArr = (q.answer || "").toUpperCase().split("").filter(c => /[A-Z]/.test(c));
          const correctSet = new Set(correctArr);
          let hasWrong = false;
          for (let s of q.userSel) { if (!correctSet.has(s)) { hasWrong = true; break; } }
          if (hasWrong) return 'wrong';
          if (q.userSel.size === correctSet.size) return 'correct';
          return 'partial';
      }

      function switchModule(key) {
        if(isExamMode) { alert("è¯·å…ˆäº¤å·"); return; }
        curMod = key;
        document.querySelectorAll('.func-btn').forEach(b => b.classList.remove('active'));
        if(key==='main') document.getElementById('btn-main').classList.add('active');
        if(key==='wrong_book') document.getElementById('btn-wrong').classList.add('active');
        if(key==='favorites') document.getElementById('btn-fav').classList.add('active');
        if(key==='random_drill') document.getElementById('btn-random').classList.add('active');

        if (key === 'wrong_book') {
            rawList = modules.main.data.filter(q => wrongSet.has(q._uid));
            curChapter = "é”™é¢˜æœ¬";
        } else if (key === 'favorites') {
            rawList = modules.main.data.filter(q => favSet.has(q._uid));
            curChapter = "æ”¶è—å¤¹";
        } else if (key === 'random_drill') {
            rawList = [...modules.main.data].sort(() => Math.random() - 0.5).map(q => ({...q, userSel: new Set(), isSubmitted: false}));
            curChapter = "ä¹±åºåˆ·é¢˜";
        } else {
            initChapterList();
            document.getElementById("qContainer").innerHTML = `<div style="text-align:center; margin-top:100px; color:var(--text-sub)">ğŸ“‚ è¯·é€‰æ‹©ç« èŠ‚</div>`;
            document.getElementById("headerTitle").innerText = "ç« èŠ‚é€‰æ‹©";
            filteredList = [];
            if(window.innerWidth <= 768) toggleSidebar();
            return;
        }
        setFilter('all');
        if (window.innerWidth <= 768) closeAll();
      }

      function initChapterList() {
        const list = document.getElementById("chapterList");
        list.innerHTML = "";
        const map = new Map();
        modules.main.data.forEach(q => { if(!map.has(q.chapter)) map.set(q.chapter, 0); map.set(q.chapter, map.get(q.chapter)+1); });
        map.forEach((total, name) => {
             const key = "ma_" + name;
             const saved = JSON.parse(localStorage.getItem(key) || "[]");
             const done = saved.filter(x => x && x.done).length;
             
             const div = document.createElement("div");
             div.className = "chapter-item";
             if (name === curChapter && curMod === 'main') div.classList.add('active');
             
             const pillClass = done === total ? "badge-pill completed" : "badge-pill";
             div.innerHTML = `<span>${name}</span><span class="${pillClass}">${done}/${total}</span>`;
             div.onclick = () => loadChapter(name);
             list.appendChild(div);
        });
      }

      function loadChapter(name) {
          curChapter = name;
          curMod = 'main';
          localStorage.setItem("last_chapter", name);
          rawList = modules.main.data.filter(q => q.chapter === name);
          const saved = JSON.parse(localStorage.getItem("ma_" + name) || "[]");
          rawList.forEach((q, i) => {
              if(saved[i]) { q.userSel = new Set(saved[i].sel || []); q.isSubmitted = saved[i].done || false; } 
              else { q.userSel = new Set(); q.isSubmitted = false; }
          });
          setFilter('all');
          
          // æ–°å¢é€»è¾‘ï¼šå¦‚æœæ˜¯èƒŒè¯µæ¨¡å¼ï¼Œè‡ªåŠ¨è·³è½¬åˆ°èƒŒè¯µè¿›åº¦
          // setFilter('all') é»˜è®¤æŠŠ curIndex è®¾ä¸ºäº† 0ï¼Œè¿™é‡Œæˆ‘ä»¬è¦è¦†ç›–å®ƒ
          if(isReciteMode && reciteProgress[name] !== undefined) {
             let savedIdx = reciteProgress[name];
             // é˜²æ­¢è¶Šç•Œ
             if(savedIdx < 0) savedIdx = 0;
             if(savedIdx >= rawList.length) savedIdx = rawList.length - 1;
             
             curIndex = savedIdx;
             // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç•Œé¢
             renderQ();
             showToast("å·²æ¢å¤èƒŒè¯µè¿›åº¦");
          }

          initChapterList();
          if (window.innerWidth <= 768) closeAll();
      }

      function saveProgress() {
          if (curMod !== 'main') return;
          const state = rawList.map(q => ({ sel: Array.from(q.userSel), done: q.isSubmitted }));
          localStorage.setItem("ma_" + curChapter, JSON.stringify(state));
      }

      function setFilter(type) {
          filterType = type;
          document.querySelectorAll('.filter-chip').forEach(c => { 
              c.classList.remove('active'); 
              c.classList.remove('active-wrong');
              c.classList.remove('active-recite');
              c.classList.remove('active-kill');
          });
          
          if(event) {
              const el = event.target;
              if(type==='wrong') el.classList.add('active-wrong');
              else if(type==='kill') el.classList.add('active-kill');
              else if(isReciteMode && type !== 'kill') el.classList.add('active-recite');
              else el.classList.add('active');
          }

          if (type === 'all') {
              // åœ¨èƒŒä¹¦æ¨¡å¼ä¸‹çš„"å…¨éƒ¨"ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦è¿‡æ»¤æ‰æ–©æ€é¢˜ã€‚ä¸ºäº†ä½“éªŒï¼Œé»˜è®¤ä¸è¿‡æ»¤ï¼Œä½†å¯ä»¥é€šè¿‡â€œæ–©â€çŠ¶æ€çœ‹å‡º
              // å¦‚æœæƒ³æè‡´ä½“éªŒï¼Œå¯ä»¥é»˜è®¤è¿‡æ»¤æ‰æ–©æ€é¢˜ï¼š
              // filteredList = rawList.filter(q => !killSet.has(q._uid));
              filteredList = rawList;
          }
          else if (type === 'wrong') filteredList = rawList.filter(q => q.isSubmitted && checkStatus(q) !== 'correct');
          else if (type === 'å•é€‰') filteredList = rawList.filter(q => getQuestionType(q) === 'single');
          else if (type === 'å¤šé€‰') filteredList = rawList.filter(q => getQuestionType(q) === 'multi');
          else if (type === 'kill') filteredList = rawList.filter(q => killSet.has(q._uid));
          
          curIndex = 0; initJumper(); renderQ();
      }

      function initJumper() {
          const sel = document.getElementById("qJumper");
          sel.innerHTML = "";
          sel.disabled = filteredList.length === 0;
          filteredList.forEach((q, i) => {
              let txt = `${i+1}. ${q.content.substring(0, 10)}...`;
              if (q.isSubmitted) { const s = checkStatus(q); txt += (s==='correct' ? 'âœ…' : (s==='partial'?'ğŸŒ—':'âŒ')); }
              sel.add(new Option(txt, i));
          });
      }
      
      function updateJumperOption(idx, status) {
          const sel = document.getElementById("qJumper");
          if(sel.options[idx]) {
              const q = filteredList[idx];
              const mark = status==='correct' ? 'âœ…' : (status==='partial' ? 'ğŸŒ—' : 'âŒ');
              sel.options[idx].text = `${idx+1}. ${q.content.substring(0, 10)}...${mark}`;
          }
      }

      function updateCounts() {
          document.getElementById("wrongCount").innerText = wrongSet.size || "";
          document.getElementById("favCount").innerText = favSet.size || "";
          document.getElementById("killCount").innerText = killSet.size || "";
      }

      window.move = (dir) => {
          // å¦‚æœæ˜¯èƒŒè¯µæ¨¡å¼ï¼Œä¸”ä¸‹ä¸€ä¸ªé¢˜ç›®æ˜¯â€œå·²æ–©æ€â€çš„ï¼Œå¯ä»¥è€ƒè™‘è‡ªåŠ¨è·³è¿‡ (æ­¤å¤„æš‚ä¸å¼ºåˆ¶è·³è¿‡ï¼Œé˜²æ­¢è¯¯è§¦åæ‰¾ä¸å›)
          // å¯ä»¥åœ¨è®¾ç½®é‡ŒåŠ ä¸€ä¸ªâ€œè‡ªåŠ¨è·³è¿‡ç†Ÿç»ƒé¢˜â€çš„å¼€å…³
          const next = curIndex + dir;
          if (next >= 0 && next < filteredList.length) { 
              curIndex = next; 
              renderQ(); 
              
              // èƒŒè¯µæ¨¡å¼ï¼šå®æ—¶ä¿å­˜è¿›åº¦
              if(isReciteMode && curMod === 'main') {
                  reciteProgress[curChapter] = curIndex;
                  localStorage.setItem("recite_progress", JSON.stringify(reciteProgress));
              }
          } 
          else { if(dir===1) showToast("æœ¬ç« å·²ç»“æŸ"); }
      };
      
      window.jumpTo = (v) => { curIndex = parseInt(v); renderQ(); };
      window.toggleSidebar = () => { document.getElementById("sidebar").classList.add("open"); document.getElementById("overlay").classList.add("active"); };
      window.closeAll = () => { document.getElementById("sidebar").classList.remove("open"); document.getElementById("overlay").classList.remove("active"); document.getElementById("scoreModal").style.display='none'; };
      
      window.resetWrongBook = () => {
          if(!confirm("âš ï¸ ç¡®å®šè¦é‡ç½®æ‰€æœ‰é”™é¢˜å—ï¼Ÿ\n\nè¿™å°†ä¼šæŠŠè¿™äº›é¢˜åœ¨ç« èŠ‚ç»ƒä¹ ä¸­çš„çŠ¶æ€ä¹Ÿé‡ç½®ä¸ºã€æœªåšã€‘ï¼Œæ–¹ä¾¿æ‚¨é‡æ–°ç»ƒä¹ ã€‚")) return;
          const chapMap = new Map();
          modules.main.data.forEach(q => { if(!chapMap.has(q.chapter)) chapMap.set(q.chapter, []); chapMap.get(q.chapter).push(q); });
          for (const [chapName, questions] of chapMap) {
              const key = "ma_" + chapName;
              const savedJson = localStorage.getItem(key);
              if(savedJson) {
                  let savedState = JSON.parse(savedJson);
                  let changed = false;
                  questions.forEach((q, i) => {
                      if(wrongSet.has(q._uid) && savedState[i]) {
                          savedState[i] = { sel: [], done: false };
                          changed = true;
                          if(curChapter === chapName) { rawList[i].isSubmitted = false; rawList[i].userSel = new Set(); }
                      }
                  });
                  if(changed) localStorage.setItem(key, JSON.stringify(savedState));
              }
          }
          wrongSet.clear(); localStorage.removeItem("wrong_questions"); updateCounts();
          if(curMod==='wrong_book') switchModule('main'); else renderQ();
          alert("é”™é¢˜å·²å…¨éƒ¨é‡ç½®ï¼Œè¯·é‡æ–°æŒ‘æˆ˜ï¼");
      }

      window.resetCurrentChapter = function() {
          if(!confirm("ç¡®å®šè¦æ¸…ç©ºæœ¬ç« çš„æ‰€æœ‰è¿›åº¦å—ï¼Ÿ")) return;
          if(curMod !== 'main') return alert("è¯·å…ˆè¿›å…¥ç« èŠ‚ç»ƒä¹ æ¨¡å¼");
          rawList.forEach(q => { q.isSubmitted = false; q.userSel = new Set(); });
          localStorage.removeItem("ma_" + curChapter);
          
          // åŒæ—¶é‡ç½®èƒŒè¯µè¿›åº¦
          if(reciteProgress[curChapter]) {
              delete reciteProgress[curChapter];
              localStorage.setItem("recite_progress", JSON.stringify(reciteProgress));
          }

          renderQ();
          initChapterList();
      }
      
      window.editExamDate = function() {
          const input = prompt("è®¾ç½®è€ƒè¯•æ—¥æœŸ (YYYY-MM-DD):", new Date().toISOString().slice(0,10));
          if(input) { const d = new Date(input); if(!isNaN(d)) { localStorage.setItem("exam_date", d.toISOString()); initCountdown(); } }
      }
      
      function initCountdown() {
          const target = localStorage.getItem("exam_date");
          let date = target ? new Date(target) : new Date(new Date().setDate(new Date().getDate() + 5));
          const diff = Math.ceil((date - new Date()) / (1000 * 60 * 60 * 24));
          document.getElementById("daysLeft").innerText = diff > 0 ? diff : 0;
          document.getElementById("examDateStr").innerText = `ç›®æ ‡: ${date.getMonth()+1}-${date.getDate()}`;
      }
      
      window.exportData = function() {
          const data = { timestamp: new Date().toISOString(), localStorage: { ...localStorage } };
          const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = `Mayuan_Backup_${new Date().toLocaleDateString()}.json`;
          a.click(); URL.revokeObjectURL(url);
      };
      
      window.importData = function() { document.getElementById("fileInput").click(); };
      window.handleFileImport = function(input) {
          const file = input.files[0];
          if(!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
              try {
                  const data = JSON.parse(e.target.result);
                  if(data.localStorage) {
                      if(confirm("æ¢å¤æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰è¿›åº¦ï¼Œç¡®å®šå—ï¼Ÿ")) {
                          localStorage.clear();
                          Object.keys(data.localStorage).forEach(k => { localStorage.setItem(k, data.localStorage[k]); });
                          alert("æ•°æ®æ¢å¤æˆåŠŸ"); location.reload();
                      }
                  } else { alert("æ— æ•ˆæ–‡ä»¶"); }
              } catch(err) { alert("æ–‡ä»¶é”™è¯¯"); }
          };
          reader.readAsText(file); input.value = "";
      };
    </script>
  </body>
</html>